/*! portfolio-allocation - v0.0.1 (2017-06-09), Roman Rubsamen <roman.rubsamen@gmail.com> */var PortfolioAllocation=PortfolioAllocation||{};PortfolioAllocation=function(a){function b(a){if(!(a instanceof Array))throw new Error("arr must be an array");if(!(a[0]instanceof Array))throw new Error("arr must be an array of arrays, arr[0] is not an array");this.nbRows=a.length,this.nbColumns=a[0].length,this.data="function"==typeof Float64Array?new Float64Array(this.nbRows*this.nbColumns):new Array(this.nbRows*this.nbColumns);for(var b=0;b<this.nbRows;++b){if(!(a[b]instanceof Array))throw new Error("arr must be an array of arrays, arr["+b+"] is not an array");if(a[b].length!==this.nbColumns)throw new Error("arr contains arrays of irregular length: index 0 - "+this.nbColmuns+", index "+b+" - "+a[b].length);for(var c=0;c<this.nbColumns;++c)this.data[b*this.nbColumns+c]=a[b][c]}return this}function c(a){if(!(a instanceof Array))throw new Error("arr must be an array");this.nbRows=a.length,this.nbColumns=1,this.data="function"==typeof Float64Array?new Float64Array(this.nbRows*this.nbColumns):new Array(this.nbRows*this.nbColumns);for(var b=0;b<this.nbRows;++b)this.data[b*this.nbColumns]=a[b];return this}function d(a,b){for(var c=new Array(a.length),d=0;d<a.length;++d)c[d]=[a[d],d];0==b?c.sort(function(a,b){return a[0]>b[0]?-1:1}):1==b&&c.sort(function(a,b){return a[0]<b[0]?-1:1});var e=new Array(a.length);e[c[0][1]]=1;for(var d=1;d<a.length;++d)c[d][0]==c[d-1][0]?e[c[d][1]]=e[c[d-1][1]]:e[c[d][1]]=d+1;return e}function e(a){for(var b=a.length,c=0,d=0,e=0;e<b;++e)d+=a[e];c=d/b;for(var f=0,e=0;e<b;++e)f+=a[e]-c;return(d+f)/b}function f(a){for(var b=a.length,c=e(a),d=0,f=0,g=0;g<b;++g){var h=a[g]-c;d+=h*h,f+=h}var i=d-f*f/b;return i/b}function g(a){var b=a.length;return f(a)*b/(b-1)}function h(a){return Math.sqrt(g(a))}function i(a){for(var b=a,c=0,d=a,e=a*a,f=1;b!=c;)b=(c=b)+(d*=e/(f+=2));return.5+b*Math.exp(-.5*e-.9189385332046728)}return a.Matrix=b,b.prototype={constructor:b,toString:function(){for(var a=0,b=0;b<this.nbRows;++b)for(var c=0;c<this.nbColumns;++c){var d=String(this.data[b*this.nbColumns+c]).length;d>a&&(a=d)}for(var e=[],b=0;b<this.nbRows;++b){e.push("[ ");for(var c=0;c<this.nbColumns;++c){var f=String(this.data[b*this.nbColumns+c]);e.push(new Array(a-f.length+1).join(" ")+f+" ")}e.push("]\n")}return e.join("")},toDoubleArray:function(a){a=a||function(a,b,c){return!0};for(var b=new Array(this.nbRows),c=0;c<this.nbRows;++c){b[c]=new Array(this.nbColumns);for(var d=0,e=0;e<this.nbColumns;++e){var f=this.data[c*this.nbColumns+e];a(c+1,e+1,f)&&(b[c][d++]=f)}b[c].length=d}return b},toArray:function(a){a=a||function(a,b,c){return!0};for(var b=new Array(this.nbRows*this.nbColumns),c=0,d=0;d<this.nbRows;++d)for(var e=0;e<this.nbColumns;++e){var f=this.data[d*this.nbColumns+e];a(d+1,e+1,f)&&(b[c++]=f)}return b.length=c,b},setValueAt:function(a,b,c){if(a<1||b<1||a>this.nbRows||b>this.nbColumns)throw Error("index out of bounds when setting matrix value, ("+a+","+b+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(a-1)*this.nbColumns+(b-1)]=c,this},getValueAt:function(a,b){if(a<1||b<1||a>this.nbRows||b>this.nbColumns)throw Error("index out of bounds when getting matrix value, ("+a+","+b+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(a-1)*this.nbColumns+(b-1)]},isSquare:function(){return this.nbRows===this.nbColumns},elemPower:function(a){var b=Object.create(this);b.nbRows=this.nbRows,b.nbColumns=this.nbColumns,b.data="function"==typeof Float64Array?new Float64Array(b.nbRows*b.nbColumns):new Array(b.nbRows*b.nbColumns);for(var c=0;c<b.nbRows;++c)for(var d=0;d<b.nbColumns;++d)b.data[c*b.nbColumns+d]=Math.pow(this.data[c*b.nbColumns+d],a);return b},getDiagonal:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");var a=Object.create(c.prototype);a.nbRows=this.nbRows,a.nbColumns=1,a.data=new Array(a.nbRows);for(var b=0;b<this.nbRows;++b)a.data[b]=this.data[b*(this.nbColumns+1)];return a},elemMap:function(a){var b=Object.create(this);b.nbRows=this.nbRows,b.nbColumns=this.nbColumns,b.data="function"==typeof Float64Array?new Float64Array(b.nbRows*b.nbColumns):new Array(b.nbRows*b.nbColumns);for(var c=0;c<b.nbRows;++c)for(var d=0;d<b.nbColumns;++d)b.data[c*b.nbColumns+d]=a(c+1,d+1,this.data[c*b.nbColumns+d]);return b}},b.areEqual=function(a,c,d){if(!(a instanceof b))throw new Error("a must be a matrix");if(!(c instanceof b))throw new Error("b must be a matrix");if(a.nbRows!==c.nbRows)return!1;if(a.nbColumns!==c.nbColumns)return!1;for(var e=a.nbRows,f=a.nbColumns,g=d||0,h=0;h<e;++h)for(var i=0;i<f;++i)if(Math.abs(a.data[h*e+i]-c.data[h*e+i])>g)return!1;return!0},b.product=function(a,c){if(!(a instanceof b))throw new Error("a must be a matrix");if(!(c instanceof b))throw new Error("b must be a matrix");if(a.nbColumns!==c.nbRows)throw new Error("Matrices sizes do not match: ("+a.nbRows+","+a.nbColumns+") - ("+c.nbRows+","+c.nbColumns+")");if(1===c.nbColumns)throw new Error("Matrix vector multiplication unsupported");var d=Object.create(b.prototype);d.nbRows=a.nbRows,d.nbColumns=c.nbColumns,d.data="function"==typeof Float64Array?new Float64Array(d.nbRows*d.nbColumns):new Array(d.nbRows*d.nbColumns);for(var e=0;e<a.nbRows;++e){for(var f=0;f<c.nbColumns;++f)d.data[e*c.nbColumns+f]=0;for(var g=0;g<a.nbColumns;++g)for(var h=a.data[e*a.nbColumns+g],f=0;f<c.nbColumns;++f)d.data[e*c.nbColumns+f]+=h*c.data[g*c.nbColumns+f]}return d},b.diagonal=function(a){if(!(a instanceof Array))throw new Error("arr must be an array");var c=Object.create(b.prototype);c.nbRows=a.length,c.nbColumns=a.length,c.data="function"==typeof Float64Array?new Float64Array(c.nbRows*c.nbColumns):new Array(c.nbRows*c.nbColumns);for(var d=0;d<c.nbRows;++d){for(var e=0;e<c.nbColumns;++e)c.data[d*c.nbColumns+e]=0;c.data[d*(c.nbColumns+1)]=a[d]}return c},a.Vector=c,c.prototype=Object.create(b.prototype),c.prototype.normalize=function(){var a=Object.create(c.prototype);a.nbRows=this.nbRows,a.nbColumns=this.nbColumns,a.data="function"==typeof Float64Array?new Float64Array(a.nbRows*a.nbColumns):new Array(a.nbRows*a.nbColumns);var b=this.sum();if(0===b)throw new Error("sum of coefficients of vector is null");for(var d=0;d<this.nbRows;++d)a.data[d]=this.data[d]/b;return a},c.areEqual=function(a,d,e){if(!(a instanceof c))throw new Error("x must be a vector");if(!(d instanceof c))throw new Error("y must be a vector");return b.areEqual(a,d,e)},c.prototype.sum=function(){for(var a=0,b=0;b<this.nbRows;++b)a+=this.data[b];return a},b.vectorProduct=function(a,d){if(!(a instanceof b))throw new Error("a must be a matrix");if(!(d instanceof c))throw new Error("x must be a vector");if(a.nbColumns!==d.nbRows)throw new Error("Matrice size does not match vector size: ("+a.nbRows+","+a.nbColumns+") - ("+d.nbRows+","+d.nbColumns+")");var e=Object.create(c.prototype);e.nbRows=a.nbRows,e.nbColumns=1,e.data="function"==typeof Float64Array?new Float64Array(e.nbRows*e.nbColumns):new Array(e.nbRows*e.nbColumns);for(var f=0;f<a.nbRows;++f){e.data[f]=0;for(var g=0;g<a.nbColumns;++g)e.data[f]+=a.data[f*a.nbColumns+g]*d.data[g]}return e},c.hadamardProduct=function(a,b){if(!(a instanceof c))throw new Error("x must be a vector");if(!(b instanceof c))throw new Error("y must be a vector");if(a.nbRows!==b.nbRows)throw new Error("Vectors sizes do not match: ("+a.nbRows+") - ("+b.nbRows+")");var d=Object.create(c.prototype);d.nbRows=a.nbRows,d.nbColumns=1,d.data="function"==typeof Float64Array?new Float64Array(d.nbRows*d.nbColumns):new Array(d.nbRows*d.nbColumns);for(var e=0;e<a.nbRows;++e)for(var f=0;f<b.nbRows;++f)d.data[e]=a.data[e]*b.data[e];return d},c.dotProduct=function(a,b){if(!(a instanceof c))throw new Error("x must be a vector");if(!(b instanceof c))throw new Error("y must be a vector");if(a.nbRows!==b.nbRows)throw new Error("Vectors sizes do not match: ("+a.nbRows+") - ("+b.nbRows+")");for(var d=0,e=0;e<a.nbRows;++e)d+=a.data[e]*b.data[e];return d},c.ones=function(a){var b=Object.create(c.prototype);b.nbRows=a,b.nbColumns=1,b.data="function"==typeof Float64Array?new Float64Array(b.nbRows*b.nbColumns):new Array(b.nbRows*b.nbColumns);for(var d=0;d<b.nbRows;++d)b.data[d]=1;return b},a.rank_=function(a,b){return d(a,b)},a.equalRiskBudgetWeights=function(a,b){var d=new c(a).elemPower(-.5).normalize();return d.toArray()},a.equalRiskContributionWeights=function(b,d){var e=b.length,f=c.ones(e).normalize();return a.riskBudgetingWeights(b,f.toArray(),d)},a.equalWeights=function(a,b){var d=c.ones(a).normalize();return d.toArray()},a.mostDiversifiedWeights=function(a,d){void 0===d&&(d={});for(var e=d.eps||1e-8,f=d.maxIter||1e3,a=new b(a),g=a.getDiagonal().elemPower(.5),h=a.nbRows,i=c.ones(h).normalize(),j=b.vectorProduct(a,i),k=Math.sqrt(c.dotProduct(j,i)),l=c.dotProduct(g,i)/k,m=0,n=!1;!n;){n=!0;for(var o=1;o<=h;++o){var p=a.getValueAt(o,o),q=j.getValueAt(o,1)-i.getValueAt(o,1)*a.getValueAt(o,o)-g.getValueAt(o,1),r=q/2,s=r>=0?1:-1,t=-(r+s*Math.abs(r)),u=t/p,v=0;i.setValueAt(o,1,v),j=b.vectorProduct(a,i),k=Math.sqrt(c.dotProduct(j,i));var w=c.dotProduct(g,i)/k;if(u>0){var x=u;i.setValueAt(o,1,x);var y=b.vectorProduct(a,i),z=Math.sqrt(c.dotProduct(y,i)),A=c.dotProduct(g,i)/z;A>w?(j=y,k=z,w=A):i.setValueAt(o,1,v)}if(Math.abs(w-l)>e&&(n=!1,l=w),++m,m>=f)throw new Error("maximum number of iterations reached: "+f)}}return i=i.normalize(),i.toArray()},a.minCorrWeights=function(f,g){var f=new b(f),j=f.getDiagonal(),k=j.elemPower(-.5),l=b.diagonal(k.toArray()),m=b.product(l,b.product(f,l)),n=m.nbRows;if(n<=2)return a.equalRiskBudgetWeights(j.toArray(),g);for(var o=m.toArray(function(a,b,c){return b>a}),p=e(o),q=h(o),r=m.elemMap(function(a,b,c){return a==b?0:1-i((c-p)/q)}),s=r.toDoubleArray(function(a,b,c){return a!=b}),t=new Array(n),u=0;u<n;++u)t[u]=e(s[u]);var v=d(t,0),w=new c(v).normalize();return w=b.vectorProduct(r,w).normalize(),w=c.hadamardProduct(w,k).normalize(),w.toArray()},a.minVarWeights=function(a,d){for(var a=new b(a),f=a.nbRows,g=a.toDoubleArray(),j=new Array(f),k=0;k<f;++k)j[k]=e(g[k]);var l=e(j),m=h(j),n=new c(j).elemMap(function(a,b,c){return 1-i((c-l)/m)}).normalize(),o=a.getDiagonal().elemPower(-1).normalize();return n=c.hadamardProduct(n,o).normalize(),n.toArray()},a.riskBudgetingWeights=function(a,d,e){void 0===e&&(e={});for(var f=e.eps||1e-8,g=e.maxIter||1e3,a=new b(a),d=new c(d),h=a.nbRows,i=c.ones(h).normalize(),j=b.vectorProduct(a,i),k=Math.sqrt(c.dotProduct(j,i)),l=0,m=!1;!m;){m=!0;for(var n=1;n<=h;++n){var o=a.getValueAt(n,n),p=j.getValueAt(n,1)-i.getValueAt(n,1)*a.getValueAt(n,n),q=-d.getValueAt(n,1)*k,r=p/2,s=r>=0?1:-1,t=r*r-o*q;if(t<0)throw new Error("discriminant not positive during iteration "+l+", covariance matrix might not be psd");var u=-(r+s*Math.sqrt(t)),v=u/o,w=q/u,x=v>0?v:w;i.setValueAt(n,1,x),j=b.vectorProduct(a,i),k=Math.sqrt(c.dotProduct(j,i));var y=i.getValueAt(n,1)*j.getValueAt(n,1)/k;if(Math.abs(y-d.getValueAt(n,1))>f&&(m=!1),++l,l>=g)throw new Error("maximum number of iterations reached: "+g)}}return i=i.normalize(),i.toArray()},a}(PortfolioAllocation||{}),"undefined"!=typeof module&&(module.exports=PortfolioAllocation);