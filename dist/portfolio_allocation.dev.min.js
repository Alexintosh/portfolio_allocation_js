/*! portfolio-allocation - v0.0.1 (2017-06-09), Roman Rubsamen <roman.rubsamen@gmail.com> */var PortfolioAllocation=PortfolioAllocation||{};PortfolioAllocation=function(a){function b(a){if(!(a instanceof Array))throw new Error("arr must be an array");if(!(a[0]instanceof Array))throw new Error("arr must be an array of arrays, arr[0] is not an array");this.nbRows=a.length,this.nbColumns=a[0].length,this.data="function"==typeof Float64Array?new Float64Array(this.nbRows*this.nbColumns):new Array(this.nbRows*this.nbColumns);for(var b=0;b<this.nbRows;++b){if(!(a[b]instanceof Array))throw new Error("arr must be an array of arrays, arr["+b+"] is not an array");if(a[b].length!==this.nbColumns)throw new Error("arr contains arrays of irregular length: index 0 - "+this.nbColmuns+", index "+b+" - "+a[b].length);for(var c=0;c<this.nbColumns;++c)this.data[b*this.nbColumns+c]=a[b][c]}return this}function c(a,c,d){if(!(a instanceof b))throw new Error("a must be a matrix");if(!(c instanceof b))throw new Error("b must be a matrix");if(a.nbRows!==c.nbRows)return!1;if(a.nbColumns!==c.nbColumns)return!1;for(var e=a.nbRows,f=a.nbColumns,g=d||0,h=0;h<e;++h)for(var i=0;i<f;++i)if(Math.abs(a.data[h*e+i]-c.data[h*e+i])>g)return!1;return!0}function d(a,c){if(!(a instanceof b))throw new Error("a must be a matrix");if(!(c instanceof b))throw new Error("b must be a matrix");if(a.nbColumns!==c.nbRows)throw new Error("Matrices sizes do not match: ("+a.nbRows+","+a.nbColumns+") - ("+c.nbRows+","+c.nbColumns+")");if(1===c.nbColumns)throw new Error("Matrix vector multiplication unsupported");var d=Object.create(b.prototype);d.nbRows=a.nbRows,d.nbColumns=c.nbColumns,d.data="function"==typeof Float64Array?new Float64Array(d.nbRows*d.nbColumns):new Array(d.nbRows*d.nbColumns);for(var e=0;e<a.nbRows;++e){for(var f=0;f<c.nbColumns;++f)d.data[e*c.nbColumns+f]=0;for(var g=0;g<a.nbColumns;++g)for(var h=a.data[e*a.nbColumns+g],f=0;f<c.nbColumns;++f)d.data[e*c.nbColumns+f]+=h*c.data[g*c.nbColumns+f]}return d}function e(a){if(!(a instanceof Array))throw new Error("arr must be an array");this.nbRows=a.length,this.nbColumns=1,this.data="function"==typeof Float64Array?new Float64Array(this.nbRows*this.nbColumns):new Array(this.nbRows*this.nbColumns);for(var b=0;b<this.nbRows;++b)this.data[b*this.nbColumns]=a[b];return this}function f(a,c){if(!(a instanceof b))throw new Error("a must be a matrix");if(!(c instanceof e))throw new Error("x must be a vector");if(a.nbColumns!==c.nbRows)throw new Error("Matrice size does not match vector size: ("+a.nbRows+","+a.nbColumns+") - ("+c.nbRows+","+c.nbColumns+")");var d=Object.create(e.prototype);d.nbRows=a.nbRows,d.nbColumns=1,d.data="function"==typeof Float64Array?new Float64Array(d.nbRows*d.nbColumns):new Array(d.nbRows*d.nbColumns);for(var f=0;f<a.nbRows;++f){d.data[f]=0;for(var g=0;g<a.nbColumns;++g)d.data[f]+=a.data[f*a.nbColumns+g]*c.data[g]}return d}function g(a,b){if(!(a instanceof e))throw new Error("x must be a vector");if(!(b instanceof e))throw new Error("y must be a vector");if(a.nbRows!==b.nbRows)throw new Error("Vectors sizes do not match: ("+a.nbRows+") - ("+b.nbRows+")");for(var c=0,d=0;d<a.nbRows;++d)c+=a.data[d]*b.data[d];return c}function h(a){var b=Object.create(e.prototype);b.nbRows=a,b.nbColumns=1,b.data="function"==typeof Float64Array?new Float64Array(b.nbRows*b.nbColumns):new Array(b.nbRows*b.nbColumns);for(var c=0;c<b.nbRows;++c)b.data[c]=1;return b}return a.Matrix_=function(a){return new b(a)},a.matrixIdentical_=function(a,b,d){return c(a,b,d)},a.matrixMatrixProduct_=function(a,b){return d(a,b)},b.prototype={constructor:b,toString:function(){for(var a=0,b=0;b<this.nbRows;++b)for(var c=0;c<this.nbColumns;++c){var d=String(this.data[b*this.nbColumns+c]).length;d>a&&(a=d)}for(var e=[],b=0;b<this.nbRows;++b){e.push("[ ");for(var c=0;c<this.nbColumns;++c){var f=String(this.data[b*this.nbColumns+c]);e.push(new Array(a-f.length+1).join(" ")+f+" ")}e.push("]\n")}return e.join("")},toArray:function(){for(var a=new Array(this.nbRows),b=0;b<this.nbRows;++b){a[b]=new Array(this.nbColumns);for(var c=0;c<this.nbColumns;++c)a[b][c]=this.data[b*this.nbColumns+c]}return a},setValueAt:function(a,b,c){if(a<1||b<1||a>this.nbRows||b>this.nbColumns)throw Error("index out of bounds when setting matrix value, ("+a+","+b+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(a-1)*this.nbColumns+(b-1)]=c,this},getValueAt:function(a,b){if(a<1||b<1||a>this.nbRows||b>this.nbColumns)throw Error("index out of bounds when getting matrix value, ("+a+","+b+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(a-1)*this.nbColumns+(b-1)]},isSquare:function(){return this.nbRows===this.nbColumns},elementWisePower:function(a){var b=Object.create(this);b.nbRows=this.nbRows,b.nbColumns=this.nbColumns,b.data="function"==typeof Float64Array?new Float64Array(b.nbRows*b.nbColumns):new Array(b.nbRows*b.nbColumns);for(var c=0;c<b.nbRows;++c)for(var d=0;d<b.nbColumns;++d)b.data[c*b.nbColumns+d]=Math.pow(this.data[c*b.nbColumns+d],a);return b}},a.Vector_=function(a){return new e(a)},a.vectorDotProduct_=function(a,b){return g(a,b)},a.matrixVectorProduct_=function(a,b){return f(a,b)},a.vectorOnes_=function(a){return h(a)},a.vectorSum_=function(a){return vectorSum_(a)},e.prototype=Object.create(b.prototype),e.prototype.toArray=function(){for(var a=new Array(this.nbRows),b=0;b<this.nbRows;++b)a[b]=this.data[b];return a},e.prototype.normalize=function(){var a=Object.create(e.prototype);a.nbRows=this.nbRows,a.nbColumns=this.nbColumns,a.data="function"==typeof Float64Array?new Float64Array(a.nbRows*a.nbColumns):new Array(a.nbRows*a.nbColumns);var b=this.sum();if(0===b)throw new Error("sum of coefficients of vector is null");for(var c=0;c<this.nbRows;++c)a.data[c]=this.data[c]/b;return a},e.prototype.sum=function(){for(var a=0,b=0;b<this.nbRows;++b)a+=this.data[b];return a},a.equalRiskBudgetWeights=function(a,b){var c=new e(a).elementWisePower(-.5).normalize();return c.toArray()},a.equalRiskContributionWeights=function(b,c){for(var d=b.length,e=new Array(d),f=0;f<d;++f)e[f]=1/d;return a.riskBudgetingWeights(b,e,c)},a.equalWeights=function(a,b){var c=h(a).normalize();return c.toArray()},a.riskBudgetingWeights=function(a,c,d){void 0===d&&(d={});for(var i=d.eps||1e-8,j=d.maxIter||1e3,a=new b(a),c=new e(c),k=a.nbRows,l=h(k).normalize(),m=f(a,l),n=Math.sqrt(g(m,l)),o=0,p=!1;!p;){p=!0;for(var r=1;r<=k;++r){var s=a.getValueAt(r,r),t=m.getValueAt(r,1)-l.getValueAt(r,1)*a.getValueAt(r,r),u=-c.getValueAt(r,1)*n,v=t/2,w=v>=0?1:-1,x=v*v-s*u;if(x<0)throw new Error("discriminant not positive during iteration "+o+", covariance matrix might not be psd");q=-(v+w*Math.sqrt(x)),r1=q/s,r2=u/q,xi_star=r1>0?r1:r2,l.setValueAt(r,1,xi_star),m=f(a,l),n=Math.sqrt(g(m,l));var y=l.getValueAt(r,1)*m.getValueAt(r,1)/n;if(Math.abs(y-c.getValueAt(r,1))>i&&(p=!1),++o,o>=j)throw new Error("maximum number of iterations reached: "+j)}}return l=l.normalize(),l.toArray()},a}(PortfolioAllocation||{}),"undefined"!=typeof module&&(module.exports=PortfolioAllocation);