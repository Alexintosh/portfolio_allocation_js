/*! portfolio-allocation - v0.0.4 (2017-12-01), Roman Rubsamen <roman.rubsamen@gmail.com> */var PortfolioAllocation=PortfolioAllocation||{};PortfolioAllocation=function(a){function b(a){function d(a){g=c(a.length,a[0].length);for(var b=0;b<g.nbRows;++b){if(!(a[b]instanceof Array))throw new Error("unsupported input type");if(a[b].length!==g.nbColumns)throw new Error("unsupported input type");for(var d=0;d<g.nbColumns;++d)g.data[b*g.nbColumns+d]=a[b][d]}return g}function e(a){g=c(a.length,1);for(var b=0;b<g.nbRows;++b)g.data[b*g.nbColumns]=a[b];return g}function f(a){return g=b.copy(a)}var g=this;if(a instanceof Array&&a[0]instanceof Array)return d(a);if(a instanceof Array)return e(a);if(a instanceof b)return f(a);throw new Error("unsupported input type")}function c(a,c,d){var e;if(void 0===d)e=Object.create(b.prototype),e.nbRows=a,e.nbColumns=c,e.data="function"==typeof Float64Array?new Float64Array(e.nbRows*e.nbColumns):new Array(e.nbRows*e.nbColumns);else{if(!(d instanceof b))throw new Error("provided output must be a matrix");if(d.nbRows!==a||d.nbColumns!==c)throw new Error("provided output matrix size does not match expected matrix size: ("+d.nbRows+","+d.nbColumns+") v.s. ("+a+","+c+")");e=d}return e}function d(a){var b={getCorrelationMatrix:function(a){for(var b=c(this.nbRows,this.nbColumns,a),d=0;d<b.nbRows;++d){for(var e=Math.sqrt(this.data[d*this.nbColumns+d]),f=0;f<d;++f)b.data[d*b.nbColumns+f]=b.data[f*this.nbColumns+d];for(var f=d;f<b.nbColumns;++f){var g=Math.sqrt(this.data[f*this.nbColumns+f]);b.data[d*b.nbColumns+f]=this.data[d*this.nbColumns+f]/(e*g)}}return b},getVariancesVector:function(a){return this.diagonal(a)},standardizedGeneralizedVariance:function(){var a=this.determinant();if(a<0)throw new Error("covariance matrix is not positive semi-definite");var b=Math.pow(a,1/this.nbRows);return b}};for(var d in b)a[d]=b[d]}function e(a,b){this.n=a,this.k=b,this.mtc=!1,this.r=new Array(b),this.t=this.n,this.h=0,this.next=function(){if(this.mtc)this.t>1&&(this.h=0),this.h++,this.t=this.r[this.h-1],this.r[this.h-1]=0,this.r[0]=this.t-1,++this.r[this.h];else{this.r[0]=this.n;for(var a=1;a<=this.k-1;++a)this.r[a]=0}return this.mtc=this.r[this.k-1]!=this.n,[this.mtc,this.r.slice()]}}function f(a,b){this.n=a,this.k=b,this.a=new Array(b),this.next_ranksb=function(){for(var a=1;a<=this.k;++a)this.a[a-1]=Math.floor((a-1)*this.n/this.k);for(var c,d,e=this.k;e>0;--e){do{var f=Math.random();c=1+Math.floor(f*this.n),d=1+Math.floor((c*this.k-1)/this.n)}while(c<=this.a[d-1]);this.a[d-1]=this.a[d-1]+1}for(var g=0,h=this.k,a=1;a<=this.k;++a)if(this.a[a-1]==Math.floor((a-1)*this.n/this.k))this.a[a-1]=0;else{g+=1;var i=this.a[a-1];this.a[a-1]=0,this.a[g-1]=i}for(;g>0;--g){d=1+Math.floor((this.a[g-1]*this.k-1)/this.n);var j=this.a[g-1]-Math.floor((d-1)*this.n/this.k);this.a[g-1]=0,this.a[h-1]=d,h-=j}d=b;for(var k;d>0;--d){var l;0!=this.a[d-1]&&(k=d,l=1+Math.floor((this.a[d-1]-1)*this.n/this.k),i=Math.floor(this.a[d-1]*this.n/this.k)-l+1);var f=Math.random();for(c=l+Math.floor(f*i),a=d,++a;a<=k&&c>=this.a[a-1];)this.a[a-2]=this.a[a-1],c+=1,++a;this.a[a-2]=c,i-=1}return this.a.slice()},this.next_rks2=function(){for(var a=this.k,b=this.n,c=0,d=0;a>0;){++d;var e=Math.random();e<=a/b&&(a-=1,this.a[c]=d,c+=1),b-=1}return this.a.slice()},b<a/2?this.next=this.next_ranksb:this.next=this.next_rks2}function g(a){this.n=a,this.mtc=!1,this.iin=new Array(a),this.ncard=0,this.next=function(){var a=[];if(this.mtc){var b=0;if(this.ncard%2!=0)for(++b;0==this.iin[b-1];)++b;this.iin[b]=1-this.iin[b],this.ncard=this.ncard+2*this.iin[b]-1,a=new Array(this.ncard);for(var c=0,d=0;d<=this.n-1;++d)1==this.iin[d]&&(a[c++]=d+1);this.mtc=this.ncard!=this.iin[this.n-1]}else{for(var d=0;d<=this.n-1;++d)this.iin[d]=0;this.mtc=!0}return[this.mtc,a]}}function h(a,b){if(a<0)throw new Error("n must be a positive integer");if(b<0)throw new Error("k must be a positive integer");if(b>a)throw new Error("k must be less than or equal to n");for(var c=1,d=1;d<=b;++d)c*=a+1-d,c/=d;return c}function i(a,b){var c=0,d=Math.abs(a),e=Math.abs(b);return d>e?(c=b/a,c=d*Math.sqrt(1+c*c)):0!=b?(c=a/b,c=e*Math.sqrt(1+c*c)):c=0,c}function j(a,b){for(var c=new Array(a.length),d=0;d<a.length;++d)c[d]=[a[d],d];0==b?c.sort(function(a,b){return a[0]>b[0]?-1:1}):1==b&&c.sort(function(a,b){return a[0]<b[0]?-1:1});var e=new Array(a.length);e[c[0][1]]=1;for(var d=1;d<a.length;++d)c[d][0]==c[d-1][0]?e[c[d][1]]=e[c[d-1][1]]:e[c[d][1]]=d+1;return e}function k(a,c){var c=c;void 0===c&&(c=.5);for(var a=new b(a),d=[],e=a.nbRows,f=new Array(e),g=0;g<f.length;++g)f[g]=g+1;for(;0!=f.length;){if(1===f.length){var h=[f[0]];f[0]=null,d.push(h)}else{for(var i=a.submatrix(f,f),j=i.toRowArray(function(a,b,c){return a!=b}),k=new Array(f),g=0;g<f.length;++g)k[g]=l(j[g]);for(var m=0,n=-1,o=-1,p=0,q=-1,r=1,g=0;g<f.length;++g)k[g]>=o&&(m=f[g],n=g,o=k[g]),k[g]<=r&&(p=f[g],q=g,r=k[g]);if(a.getValueAt(m,p)>c){var s=m===p?[m]:[m,p];f[n]=null,f[q]=null;for(var g=0;g<f.length;++g)if(null!==f[g]){var t=(a.getValueAt(f[g],m)+a.getValueAt(f[g],p))/2;t>c&&(s.push(f[g]),f[g]=null)}d.push(s)}else{var u=[m];f[n]=null;for(var g=0;g<f.length;++g)null!==f[g]&&a.getValueAt(f[g],m)>c&&(u.push(f[g]),f[g]=null);if(d.push(u),m!==p){var v=[p];f[q]=null;for(var g=0;g<f.length;++g)null!==f[g]&&a.getValueAt(f[g],p)>c&&(v.push(f[g]),f[g]=null);d.push(v)}}}for(var w=[],g=0;g<f.length;++g)null!==f[g]&&w.push(f[g]);f=w}return d}function l(a){for(var b=a.length,c=0,d=0,e=0;e<b;++e)d+=a[e];c=d/b;for(var f=0,e=0;e<b;++e)f+=a[e]-c;return(d+f)/b}function m(a){for(var b=a.length,c=l(a),d=0,e=0,f=0;f<b;++f){var g=a[f]-c;d+=g*g,e+=g}var h=d-e*e/b;return h/b}function n(a){var b=a.length;return m(a)*b/(b-1)}function o(a){return Math.sqrt(n(a))}function p(a){for(var b=a,c=0,d=a,e=a*a,f=1;b!=c;)b=(c=b)+(d*=e/(f+=2));return.5+b*Math.exp(-.5*e-.9189385332046728)}function q(a,b){for(var c=a.length,d=l(a),e=l(b),f=0,g=0,h=0,i=0;i<c;++i){var j=a[i]-d,k=b[i]-e;f+=j*k,g+=j,h+=k}var m=f-g*h/c;return m/c}function r(a,b){var c=a.length;return q(a,b)*c/(c-1)}function s(a,c,d,e){void 0===e&&(e={});var f=e.eps||1e-12,g=1e-14,h=1e-10,i=1e-8,j=e.t||.666666666666,k=e.maxIter||1e4;if(!(a instanceof b))throw new Error("first input must be a matrix");if(!(c instanceof b))throw new Error("second input must be a matrix");if(!(d instanceof b))throw new Error("third input must be a matrix");if(a.nbRows>a.nbColumns)throw new Error("first input matrix has more rows than columns: ("+a.nbColumns+") v.s. ("+a.nbRows+")");if(a.nbRows!==c.nbRows)throw new Error("first and second inputs number of rows do not match: "+a.nbRows+"-"+c.nbRows);if(a.nbColumns!==d.nbRows)throw new Error("first input number of columns and third input number of rows do not match: "+a.nbColumns+"-"+d.nbRows);for(var l=a.nbRows,m=a.nbColumns,n=Number.MAX_VALUE,o=c.vectorNorm("infinity"),p=b.ones(a.nbColumns,1),q=p.transpose(),r=b.zeros(l,m),s=b.zeros(l,1),t=b.zeros(m,1),u=b.zeros(m,1),v=b.zeros(m,1),w=0;;){if(++w,w>k)throw new Error("maximum number of iterations reached: "+k);if(n=b.vectorDotProduct(d,p),q=p.transpose(q),r=b.elementwiseProduct(a,q,r),s=b.axpby(1,b.product(a,p),-1,c,s),s.vectorNorm("infinity")>h||s.vectorNorm("infinity")>i*(1+o)){var x=b.axty(1,r,r),y=s,z=b.linsolveKaczmarz(x,y,{maxIter:-1});t=b.atxy(1,a,z,t),u=b.elementwiseProduct(t,p,u),v=b.elementwiseProduct(u,p,v);var A=u.vectorNorm("infinity"),B=-t.min();b.vectorDotProduct(s,z);if(A+B*p.max()<g/m)return[null,null,1];p=A<j?b.axpby(1,p,-1,v,p):b.axpby(1,p,-j/A,v,p)}else{if(!p.isPositive())throw new Error("interiority lost for the sequence of iterates at iteration: "+w+", with value: "+p.toString());var x=b.axty(1,r,r),y=b.product(r,b.elementwiseProduct(d,p)),z=b.linsolveKaczmarz(x,y,{maxIter:-1});t=b.axpby(1,d,-1,b.atxy(1,a,z),t),u=b.elementwiseProduct(t,p,u);var A=u.vectorNorm("infinity"),B=-t.min();if(A+B*p.max()<f/m*(1+Math.abs(n)))return[p,n,0];if(A<=Number.EPSILON)return[p,n,2];if(u.isNonPositive())return[null,Number.NEGATIVE_INFINITY,3];v=b.elementwiseProduct(u,p,v),p=b.axpby(1,p,-j/A,v,p)}}}function t(a,b){this.n=a,this.k=b,this.compositionIterator=new e(b,a),this.compositionIteratorStatus=!0,this.sample=function(){if(!this.compositionIteratorStatus)return null;for(var a=this.compositionIterator.next(),c=a[1],d=0;d<c.length;++d)c[d]=c[d]/b;return this.compositionIteratorStatus=a[0],c}}function u(a){this.n=a,this.x=new Array(a),this.sample=function(){for(var a=0,b=0;b<this.n;++b){var c=1-Math.random(),d=Math.log(c);this.x[b]=d,a+=d}for(var b=0;b<this.n;++b)this.x[b]=this.x[b]/a;return this.x.slice()}}function v(a,b){for(var c=b,d=new Array(a.length),e=0;e<a.length;++e){var f=b*a[e],g=Math.floor(f),h=f-g;c-=g,d[e]=[g,h,e]}d.sort(function(a,b){return b[1]<a[1]?-1:b[1]>a[1]?1:b[0]-a[0]});for(var i=new Array(a.length),e=0;e<c;++e){var j=d[e][2];i[j]=(d[e][0]+1)/b}for(var e=c;e<d.length;++e){var j=d[e][2];i[j]=d[e][0]/b}return i}function w(a,b,c){for(var d=Number.POSITIVE_INFINITY,e=[],f=new t(b,c),g=f.sample();null!==g;){var h=a(g);h<d?(d=h,e=[g]):h==d&&e.push(g),g=f.sample()}return e}return a.Matrix=b,b.prototype={constructor:b,toString:function(){for(var a=0,b=0;b<this.nbRows;++b)for(var c=0;c<this.nbColumns;++c){var d=String(this.data[b*this.nbColumns+c]).length;d>a&&(a=d)}for(var e=[],b=0;b<this.nbRows;++b){e.push("[ ");for(var c=0;c<this.nbColumns;++c){var f=String(this.data[b*this.nbColumns+c]);e.push(new Array(a-f.length+1).join(" ")+f+" ")}e.push("]\n")}return e.join("")},toRowArray:function(a){a=a||function(a,b,c){return!0};for(var b=new Array(this.nbRows),c=0;c<this.nbRows;++c){b[c]=new Array(this.nbColumns);for(var d=0,e=0;e<this.nbColumns;++e){var f=this.data[c*this.nbColumns+e];a(c+1,e+1,f)&&(b[c][d++]=f)}b[c].length=d}return b},toArray:function(a){a=a||function(a,b,c){return!0};for(var b=new Array(this.nbRows*this.nbColumns),c=0,d=0;d<this.nbRows;++d)for(var e=0;e<this.nbColumns;++e){var f=this.data[d*this.nbColumns+e];a(d+1,e+1,f)&&(b[c++]=f)}return b.length=c,b},setValueAt:function(a,b,c){if(a<1||b<1||a>this.nbRows||b>this.nbColumns)throw new Error("index out of bounds when setting matrix value, ("+a+","+b+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(a-1)*this.nbColumns+(b-1)]=c,this},getValueAt:function(a,b){if(a<1||b<1||a>this.nbRows||b>this.nbColumns)throw new Error("index out of bounds when getting matrix value, ("+a+","+b+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(a-1)*this.nbColumns+(b-1)]},isSquare:function(){return this.nbRows===this.nbColumns},isVector:function(){return 1===this.nbColumns},isNonNegative:function(){for(var a=0;a<this.nbRows;++a)for(var b=0;b<this.nbColumns;++b)if(this.data[a*this.nbColumns+b]<0)return!1;return!0},isPositive:function(){for(var a=0;a<this.nbRows;++a)for(var b=0;b<this.nbColumns;++b)if(this.data[a*this.nbColumns+b]<=0)return!1;return!0},isNonPositive:function(){for(var a=0;a<this.nbRows;++a)for(var b=0;b<this.nbColumns;++b)if(this.data[a*this.nbColumns+b]>0)return!1;return!0},isNegative:function(){for(var a=0;a<this.nbRows;++a)for(var b=0;b<this.nbColumns;++b)if(this.data[a*this.nbColumns+b]>=0)return!1;return!0},sum:function(){for(var a=0,b=0;b<this.data.length;++b)a+=this.data[b];return a},min:function(){for(var a=Number.POSITIVE_INFINITY,b=0;b<this.data.length;++b)this.data[b]<a&&(a=this.data[b]);return a},max:function(){for(var a=Number.NEGATIVE_INFINITY,b=0;b<this.data.length;++b)this.data[b]>a&&(a=this.data[b]);return a},normalize:function(a){var b=c(this.nbRows,this.nbColumns,a),d=this.sum();if(0===d)throw new Error("sum of coefficients of matrix is null");for(var e=0;e<b.nbRows;++e)for(var f=0;f<b.nbColumns;++f)b.data[e*b.nbColumns+f]=this.data[e*this.nbColumns+f]/d;return b},diagonal:function(a){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var b=c(this.nbRows,1,a),d=0;d<this.nbRows;++d)b.data[d]=this.data[d*(this.nbColumns+1)];return b},row:function(a,b){if(a<1||a>this.nbRows)throw new Error("index out of bounds when getting matrix row, ("+a+") in size ("+this.nbRows+","+this.nbColumns+")");for(var d=c(this.nbColumns,1,b),e=0;e<this.nbColumns;++e)d.data[e]=this.data[(a-1)*this.nbColumns+e];return d},elemMap:function(a,b){for(var d=c(this.nbRows,this.nbColumns,b),e=0;e<d.nbRows;++e)for(var f=0;f<d.nbColumns;++f)d.data[e*d.nbColumns+f]=a(e+1,f+1,this.data[e*this.nbColumns+f]);return d},submatrix:function(a,b,d){if(!(a instanceof Array)||0==a.length)throw new Error("first parameter must be a non empty array");if(!(b instanceof Array)||0==b.length)throw new Error("second parameter must be a non empty array");for(var e=1;e<a.length;++e)if(a[e-1]>=a[e])throw new Error("first parameter must be a sorted array");for(var f=1;f<b.length;++f)if(b[f-1]>=a[f])throw new Error("second parameter must be a sorted array");for(var g=c(a.length,b.length,d),e=0;e<g.nbRows;++e)for(var h=a[e]-1,f=0;f<g.nbColumns;++f){var i=b[f]-1;g.data[e*g.nbColumns+f]=this.data[h*this.nbColumns+i]}return g},transpose:function(a){for(var b=c(this.nbColumns,this.nbRows,a),d=0;d<b.nbRows;++d)for(var e=0;e<b.nbColumns;++e)b.data[d*b.nbColumns+e]=this.data[e*this.nbColumns+d];return b},determinant:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var a=b.qrDecomposition(this),c=a[1],d=1,e=0;e<c.nbRows;++e)d*=c.data[e*c.nbColumns+e];return d},matrixNorm:function(a){if("one"==a){for(var b=0,c=0;c<this.nbColumns;++c){for(var d=0,e=0;e<this.nbRows;++e)d+=Math.abs(this.data[e*this.nbColumns+c]);b=Math.max(b,d)}return b}if("infinity"==a){for(var f=0,e=0;e<this.nbRows;++e){for(var g=0,c=0;c<this.nbColumns;++c)g+=Math.abs(this.data[e*this.nbColumns+c]);f=Math.max(f,g)}return f}if("frobenius"==a)return this.vectorNorm("two");throw new Error("unsupported matrix norm: "+a)},vectorNorm:function(a,b,c){var d,e,f,g;if(void 0===b||"matrix"==b)d=0,e=this.nbRows,f=0,g=this.nbColumns;else if("row"==b){if(void 0===c)throw new Error("undefined row index");if(c<1||c>this.nbRows)throw new Error("row index out of bounds: "+c);d=c-1,e=c,f=0,g=this.nbColumns}else if("column"==b){if(void 0===c)throw new Error("undefined row index");if(c<1||c>this.nbColumns)throw new Error("column index out of bounds: "+c);d=0,e=this.nbRows,f=c-1,g=c}else if(void 0!==b)throw new Error("unsupported matrix subset: "+b);if("one"==a){for(var h=0,i=d;i<e;++i)for(var j=f;j<g;++j)h+=Math.abs(this.data[i*this.nbColumns+j]);return h}if("two"==a){for(var k=0,l=1,i=d;i<e;++i)for(var j=f;j<g;++j){var m=this.data[i*this.nbColumns+j],n=Math.abs(m);0!=n&&(n>k?(l=1+l*(k/m)*(k/m),k=n):l+=m/k*(m/k))}return k*Math.sqrt(l)}if("infinity"==a){for(var o=0,i=d;i<e;++i)for(var j=f;j<g;++j)o=Math.max(o,Math.abs(this.data[i*this.nbColumns+j]));return o}throw new Error("unsupported vector norm: "+a)}},b.areEqual=function(a,c,d){if(!(a instanceof b))throw new Error("a must be a matrix");if(!(c instanceof b))throw new Error("b must be a matrix");if(a.nbRows!==c.nbRows)return!1;if(a.nbColumns!==c.nbColumns)return!1;for(var e=a.nbRows,f=a.nbColumns,g=d||0,h=0;h<e;++h)for(var i=0;i<f;++i)if(Math.abs(a.data[h*f+i]-c.data[h*f+i])>g)return!1;return!0},b.axpby=function(a,d,e,f,g){if(!(d instanceof b))throw new Error("first input must be a matrix");if(!(f instanceof b))throw new Error("second input must be a matrix");if(d.nbColumns!==f.nbColumns||d.nbRows!==f.nbRows)throw new Error("input matrices sizes do not match: ("+d.nbRows+","+d.nbColumns+") - ("+f.nbRows+","+f.nbColumns+")");for(var h=c(d.nbRows,d.nbColumns,g),i=0;i<h.nbRows;++i)for(var j=0;j<h.nbColumns;++j)h.data[i*h.nbColumns+j]=a*d.data[i*d.nbColumns+j]+e*f.data[i*f.nbColumns+j];return h},b.copy=function(a,d){if(!(a instanceof b))throw new Error("first input must be a matrix");for(var e=c(a.nbRows,a.nbColumns,d),f=0;f<e.nbRows;++f)for(var g=0;g<e.nbColumns;++g)e.data[f*e.nbColumns+g]=a.data[f*a.nbColumns+g];return e},b.product=function(a,c,d){return b.axy(1,a,c)},b.elementwiseProduct=function(a,d,e){if(!(a instanceof b))throw new Error("first input must be a matrix");if(!(d instanceof b))throw new Error("second input must be a matrix");if(!(a.nbRows===d.nbRows&&a.nbColumns===d.nbColumns||d.nbRows===a.nbRows&&1===d.nbColumns||1===d.nbRows&&d.nbColumns===a.nbColumns))throw new Error("input matrices sizes do not match: ("+a.nbRows+","+a.nbColumns+") - ("+d.nbRows+","+d.nbColumns+")");var f=c(a.nbRows,a.nbColumns,e);if(a.nbRows===d.nbRows&&a.nbColumns===d.nbColumns)for(var g=0;g<f.nbRows;++g)for(var h=0;h<f.nbColumns;++h)f.data[g*f.nbColumns+h]=a.data[g*a.nbColumns+h]*d.data[g*d.nbColumns+h];else if(d.nbRows===a.nbRows&&1===d.nbColumns)for(var g=0;g<f.nbRows;++g)for(var i=d.data[g],h=0;h<f.nbColumns;++h)f.data[g*f.nbColumns+h]=a.data[g*a.nbColumns+h]*i;else if(1===d.nbRows&&d.nbColumns===a.nbColumns)for(var g=0;g<f.nbRows;++g)for(var h=0;h<f.nbColumns;++h)f.data[g*f.nbColumns+h]=a.data[g*a.nbColumns+h]*d.data[h];return f},b.axy=function(a,d,e,f){if(!(d instanceof b))throw new Error("second input must be a matrix");if(!(e instanceof b))throw new Error("third input must be a matrix");if(d.nbColumns!==e.nbRows)throw new Error("matrices sizes do not match: ("+d.nbRows+","+e.nbColumns+") - ("+e.nbRows+","+e.nbColumns+")");for(var g=c(d.nbRows,e.nbColumns,f),h=0;h<d.nbRows;++h){for(var i=0;i<e.nbColumns;++i)g.data[h*g.nbColumns+i]=0;for(var j=0;j<d.nbColumns;++j)for(var k=a*d.data[h*d.nbColumns+j],i=0;i<e.nbColumns;++i)g.data[h*g.nbColumns+i]+=k*e.data[j*e.nbColumns+i]}return g},b.axty=function(a,d,e,f){if(!(d instanceof b))throw new Error("second input must be a matrix");if(!(e instanceof b))throw new Error("third input must be a matrix");if(d.nbColumns!==e.nbColumns)throw new Error("matrices sizes do not match: ("+d.nbRows+","+e.nbColumns+") - ("+e.nbRows+","+e.nbColumns+")");for(var g=c(d.nbRows,e.nbRows,f),h=0;h<d.nbRows;++h)for(var i=0;i<e.nbRows;++i){g.data[h*g.nbColumns+i]=0;for(var j=0;j<d.nbColumns;++j)g.data[h*g.nbColumns+i]+=d.data[h*d.nbColumns+j]*e.data[i*e.nbColumns+j];g.data[h*g.nbColumns+i]=a*g.data[h*g.nbColumns+i]}return g},b.atxy=function(a,d,e,f){if(!(d instanceof b))throw new Error("second input must be a matrix");if(!(e instanceof b))throw new Error("third input must be a matrix");if(d.nbRows!==e.nbRows)throw new Error("matrices sizes do not match: ("+d.nbRows+","+e.nbColumns+") - ("+e.nbRows+","+e.nbColumns+")");for(var g=c(d.nbColumns,e.nbColumns,f),h=0,i=0;i<d.nbColumns;++i){for(var j=a*d.data[h*d.nbColumns+i],k=0;k<e.nbColumns;++k)g.data[i*g.nbColumns+k]=0;for(var k=0;k<e.nbColumns;++k)g.data[i*g.nbColumns+k]+=j*e.data[h*e.nbColumns+k]}for(var h=1;h<d.nbRows;++h)for(var i=0;i<d.nbColumns;++i)for(var j=a*d.data[h*d.nbColumns+i],k=0;k<e.nbColumns;++k)g.data[i*g.nbColumns+k]+=j*e.data[h*e.nbColumns+k];return g},b.diagonal=function(a,d){if(!(a instanceof b&&a.isVector()))throw new Error("first input must be a vector");for(var e=c(a.nbRows,a.nbRows,d),f=0;f<e.nbRows;++f){for(var g=0;g<e.nbColumns;++g)e.data[f*e.nbColumns+g]=0;e.data[f*e.nbColumns+f]=a.data[f*a.nbColumns]}return e},b.fillSymetric=function(a,b,d){if(a<1)throw new Error("input number of rows and columns out of bounds: "+a);for(var e=c(a,a,d),f=0;f<e.nbRows;++f){for(var g=0;g<f;++g)e.data[f*e.nbColumns+g]=e.data[g*e.nbColumns+f];for(var g=f;g<e.nbColumns;++g)e.data[f*e.nbColumns+g]=b(f+1,g+1)}return e},b.fill=function(a,b,d,e){if(a<1)throw new Error("input number of rows out of bounds: "+a);if(b<1)throw new Error("input number of columns out of bounds: "+b);for(var f=c(a,b,e),g=0;g<f.nbRows;++g)for(var h=0;h<f.nbColumns;++h)f.data[g*f.nbColumns+h]=d(g+1,h+1);return f},b.zeros=function(a,b){for(var d=c(a,b),e=0;e<d.nbRows;++e)for(var f=0;f<d.nbColumns;++f)d.data[e*d.nbColumns+f]=0;return d},b.ones=function(a,b){for(var d=c(a,b),e=0;e<d.nbRows;++e)for(var f=0;f<d.nbColumns;++f)d.data[e*d.nbColumns+f]=1;return d},b.identity=function(a){for(var b=c(a,a),d=0;d<b.nbRows;++d){for(var e=0;e<b.nbColumns;++e)b.data[d*b.nbColumns+e]=0;b.data[d*b.nbColumns+d]=1}return b},b.vectorHadamardProduct=function(a,c){return b.elementwiseProduct(a,c)},b.vectorDotProduct=function(a,b){if(!a.isVector())throw new Error("first argument must be a vector");if(!b.isVector())throw new Error("second argument must be a vector");if(a.nbRows!==b.nbRows)throw new Error("Vectors sizes do not match: ("+a.nbRows+") - ("+b.nbRows+")");for(var c=0,d=0;d<a.nbRows;++d)c+=a.data[d]*b.data[d];return c},b.qrDecomposition=function(a){function c(a,b){var c=NaN,d=NaN,e=NaN;if(0==b)c=a>=0?1:-1,d=0,e=Math.abs(a);else if(0==a)c=0,d=b>=0?1:-1,e=Math.abs(b);else if(Math.abs(a)>Math.abs(b)){var f=b/a,g=(a>=0?1:-1)*Math.sqrt(1+f*f);c=1/g,d=f*c,e=a*g}else{var f=a/b,g=(b>=0?1:-1)*Math.sqrt(1+f*f);d=1/g,c=f*d,e=b*g}return[c,-d,e]}if(a.nbRows<a.nbColumns)throw new Error("matrix has more columns than rows: ("+a.nbRows+") v.s. ("+a.nbColumns+")");for(var d=a.nbRows,e=a.nbColumns,f=new b(a),g=b.identity(d),h=1;h<=e;++h)for(var i=d;i>=h+1;--i){var a=f.data[(i-2)*f.nbColumns+(h-1)],j=f.data[(i-1)*f.nbColumns+(h-1)],k=c(a,j),l=k[0],m=k[1],n=k[2];f.data[(i-2)*f.nbColumns+(h-1)]=n,f.data[(i-1)*f.nbColumns+(h-1)]=0;for(var o=h+1;o<=e;++o){var p=f.data[(i-2)*f.nbColumns+(o-1)],q=f.data[(i-1)*f.nbColumns+(o-1)];f.data[(i-2)*f.nbColumns+(o-1)]=l*p-m*q,f.data[(i-1)*f.nbColumns+(o-1)]=m*p+l*q}for(var o=1;o<=d;++o){var p=g.data[(o-1)*g.nbColumns+(i-2)],q=g.data[(o-1)*g.nbColumns+(i-1)];g.data[(o-1)*g.nbColumns+(i-2)]=l*p-m*q,g.data[(o-1)*g.nbColumns+(i-1)]=m*p+l*q}}return[g,f]},b.linsolveKaczmarz=function(a,c,d){void 0===d&&(d={});var e=d.epsAbs||1e-14,f=d.epsRel||1e-12,g=d.maxIter||1e4;if(!(a instanceof b))throw new Error("first input must be a matrix");if(!(c instanceof b))throw new Error("second input must be a matrix");if(a.nbRows!==c.nbRows)throw new Error("matrix and second member sizes do not match: ("+a.nbRows+","+a.nbColumns+") - ("+c.nbRows+","+c.nbColumns+")");if(1!==c.nbColumns)throw new Error("b is not a vector: ("+c.nbRows+","+c.nbColumns+")");if(a.nbRows<a.nbColumns)throw new Error("matrix has more columns than rows: ("+a.nbRows+") v.s. ("+a.nbColumns+")");for(var h=a.nbRows,i=a.nbColumns,j=new b.zeros(i,1),k=new b.zeros(i,1),l=b.copy(c),m=b.copy(c),n=new Array(h),o=1;o<=h;++o){var p=a.vectorNorm("two","row",o);p<=Number.EPSILON?n[o-1]=0:n[o-1]=p*p}for(var q=new Array(i),r=1;r<=i;++r){var s=a.vectorNorm("two","column",r);s<=Number.EPSILON?q[r-1]=0:q[r-1]=s*s}for(var t=0,u=new b.zeros(i,1);;){if(++t,g!==-1&&t>g)throw new Error("maximum number of iterations reached: "+g);for(var r=1;r<=i;++r)if(0!=q[r-1]){for(var v=0,o=1;o<=h;++o)v+=a.data[(o-1)*a.nbColumns+(r-1)]*l.data[(o-1)*l.nbColumns];for(var o=1;o<=h;++o)l.data[(o-1)*l.nbColumns]-=v/q[r-1]*a.data[(o-1)*a.nbColumns+(r-1)]}m=b.axpby(1,c,-1,l,m);for(var o=1;o<=h;++o)if(0!=n[o-1]){for(var w=0,r=1;r<=i;++r)w+=a.data[(o-1)*a.nbColumns+(r-1)]*k.data[(r-1)*k.nbColumns];for(var x=w-m.data[(o-1)*c.nbColumns],r=1;r<=i;++r)k.data[(r-1)*k.nbColumns]-=x/n[o-1]*a.data[(o-1)*a.nbColumns+(r-1)]}var y=b.axpby(1,k,-1,j,u).vectorNorm("infinity");if(y<=e&&y<=f*(1+k.vectorNorm("infinity")))break;j=b.copy(k,j)}return k},a.covarianceMatrix=function(a){for(var b=arguments,e=c(b.length,b.length),f=0;f<e.nbRows;++f){for(var g=0;g<f;++g)e.data[f*e.nbColumns+g]=e.data[g*e.nbColumns+f];for(var g=f;g<e.nbColumns;++g)e.data[f*e.nbColumns+g]=q(b[f],b[g])}return d(e),e},a.sampleCovarianceMatrix=function(a){for(var b=arguments,e=c(b.length,b.length),f=0;f<e.nbRows;++f){for(var g=0;g<f;++g)e.data[f*e.nbColumns+g]=e.data[g*e.nbColumns+f];for(var g=f;g<e.nbColumns;++g)e.data[f*e.nbColumns+g]=r(b[f],b[g])}return d(e),e},b.prototype.toCovarianceMatrix=function(){new b(this);return d(this),this},a.compositionsIterator_=e,a.subsetsIterator_=g,a.randomKSubsetIterator_=f,a.binomial_=h,a.hypot_=function(a,b){return i(a,b)},a.rank_=function(a,b){return j(a,b)},a.ftca_=function(a,b){return k(a,b)},a.lpsolveAffineScaling_=s,a.simplexRationalRounding_=v,a.simplexRandomSampler_=u,a.simplexDeterministicRationalSampler_=t,a.simplexRationalGirdSearch_=w,a.clusterRiskParityWeights=function(c,d){void 0===d&&(d={});var e=d.clusteringMode||"ftca",c=new b(c).toCovarianceMatrix(c),f=c.nbRows,g=[];if("manual"===e){g=d.clusters||[];for(var h=new Array(f),i=0;i<h.length;++i)h[i]=0;for(var j=0;j<g.length;++j){if(0===g[j].length)throw new Error("empty cluster at index: "+j);for(var l=0;l<g[j].length;++l){var m=g[j][l];if(m<1||m>f)throw new Error("asset index out of bounds: "+m);h[m-1]++}}for(var i=0;i<h.length;++i)if(1!==h[i])throw 0===h[i]?new Error("missing asset index: "+(i+1)):h[i]>1?new Error("duplicate asset index: "+(i+1)):new Error("unknown error")}else{if("ftca"!==e)throw new Error("unsupported clustering method");var n=c.getCorrelationMatrix().toRowArray();g=k(n,d.ftcaThreshold)}for(var o=g.length,p=b.zeros(o,f),i=0;i<o;++i)for(var q=g[i].slice().sort(function(a,b){return a-b}),r=c.submatrix(q,q),s=a.equalRiskContributionWeights(r,d),j=0;j<s.length;++j)p.setValueAt(i+1,q[j],s[j]);var t=p.transpose(),u=b.product(p,b.product(c,t)),v=a.equalRiskContributionWeights(u,d),w=b.product(t,new b(v));return w.toArray()},a.equalRiskBoundingWeights=function(c,d){void 0===d&&(d={});var c=(d.eps||1e-8,d.maxIter||1e4,new b(c)),e=c.nbRows,f=Number.MAX_VALUE,h=[],i=[],j=new g(e),k=j.next();do{var k=j.next(),l=k[1],m=c.submatrix(l,l),n=a.equalRiskContributionWeights(m,d);assetsWeightsMatrix=new b(n);var o=assetsWeightsMatrix.getValueAt(1,1)*b.product(m,assetsWeightsMatrix).getValueAt(1,1);o<f&&(f=o,h=l,i=n)}while(k[0]);for(var p=b.zeros(e,1),q=0;q<h.length;++q)p.setValueAt(h[q],1,i[q]);return p.toArray()},a.equalRiskBudgetWeights=function(a,c){var d=new b(a).elemMap(function(a,b,c){return 1/Math.sqrt(c)});return d=d.normalize(d),d.toArray()},a.equalRiskContributionWeights=function(c,d){var c=new b(c),e=c.nbRows,f=b.ones(e,1).normalize();return a.riskBudgetingWeights(c,f,d)},a.equalWeights=function(a,c){var d=b.ones(a,1);return d=d.normalize(d),d.toArray()},a.globalMinimumVarianceWeights=function(a,c){void 0===c&&(c={});var d=c.eps||1e-8,e=c.maxIter||1e4,a=new b(a),f=a.nbRows,g=b.ones(f,1);g=g.normalize(g);for(var h=b.product(a,g),i=b.product(a,g),j=b.vectorDotProduct(h,g),k=.5*j-g.sum(),l=0,m=!1;!m;){m=!0;for(var n=1;n<=f;++n){var o=a.getValueAt(n,n),p=h.getValueAt(n,1)-g.getValueAt(n,1)*a.getValueAt(n,n)-1,q=p/2,r=q>=0?1:-1,s=-(q+r*Math.abs(q)),t=s/o,u=0;g.setValueAt(n,1,u),h=b.product(a,g,h),j=b.vectorDotProduct(h,g);var v=.5*j-g.sum();if(t>0){var w=t;g.setValueAt(n,1,w),i=b.product(a,g,i);var x=b.vectorDotProduct(i,g),y=.5*x-g.sum();y<v?(h=b.copy(i,h),j=x,v=y):g.setValueAt(n,1,u)}}if(Math.abs(v-k)>d&&(m=!1,k=v),++l,l>e)throw new Error("maximum number of iterations reached: "+e)}return g=g.normalize(g),g.toArray()},a.gridSearchWeights=function(a,b,c){if(void 0===c&&(c={}),c.optimisationMethod=c.optimisationMethod||"deterministic","deterministic"===c.optimisationMethod){c.rationalGrid=c.rationalGrid||{k:a};var d=c.rationalGrid.k;return w(b,a,d)}throw new Error("unsupported optimisation method")},a.minCorrWeights=function(c,d){var c=new b(c).toCovarianceMatrix(),e=c.getVariancesVector(),f=e.elemMap(function(a,b,c){return 1/Math.sqrt(c)}),g=c.getCorrelationMatrix(),h=g.nbRows;if(h<=2)return a.equalRiskBudgetWeights(e,d);for(var i=g.toArray(function(a,b,c){return b>a}),k=l(i),m=o(i),n=g.elemMap(function(a,b,c){return a==b?0:1-p((c-k)/m)}),q=n.toRowArray(function(a,b,c){return a!=b}),r=new Array(h),s=0;s<h;++s)r[s]=l(q[s]);var t=j(r,0),u=new b(t,1).normalize();return u=b.product(n,u).normalize(),u=b.vectorHadamardProduct(u,f).normalize(),u.toArray()},a.mostDiversifiedWeights=function(a,c){void 0===c&&(c={});var d=c.eps||1e-8,e=c.maxIter||1e4,a=new b(a),f=a.diagonal().elemMap(function(a,b,c){return Math.sqrt(c)}),g=a.nbRows,h=b.ones(g,1);h=h.normalize(h);for(var i=b.product(a,h),j=b.product(a,h),k=Math.sqrt(b.vectorDotProduct(i,h)),l=b.vectorDotProduct(f,h)/k,m=0,n=!1;!n;){n=!0;for(var o=1;o<=g;++o){var p=a.getValueAt(o,o),q=i.getValueAt(o,1)-h.getValueAt(o,1)*a.getValueAt(o,o)-f.getValueAt(o,1),r=q/2,s=r>=0?1:-1,t=-(r+s*Math.abs(r)),u=t/p,v=0;h.setValueAt(o,1,v),i=b.product(a,h,i),k=Math.sqrt(b.vectorDotProduct(i,h));var w=b.vectorDotProduct(f,h)/k;if(u>0){var x=u;h.setValueAt(o,1,x),j=b.product(a,h,j);var y=Math.sqrt(b.vectorDotProduct(j,h)),z=b.vectorDotProduct(f,h)/y;z>w?(i=b.copy(j,i),k=y,w=z):h.setValueAt(o,1,v)}}if(Math.abs(w-l)>d&&(n=!1,l=w),++m,m>e)throw new Error("maximum number of iterations reached: "+e)}return h=h.normalize(h),h.toArray()},a.minVarWeights=function(a,c){for(var a=new b(a),d=a.nbRows,e=a.toRowArray(),f=new Array(d),g=0;g<d;++g)f[g]=l(e[g]);var h=l(f),i=o(f),j=new b(f,1).elemMap(function(a,b,c){return 1-p((c-h)/i)});j=j.normalize(j);var k=a.diagonal().elemMap(function(a,b,c){return 1/c}).normalize();return j=b.vectorHadamardProduct(j,k).normalize(),j.toArray()},a.randomWeights=function(a,c){void 0===c&&(c={contraints:{}});for(var d,e=c.contraints.minAssets||1,g=c.contraints.maxAssets||a,h=Math.floor(Math.random()*(g-e+1))+e,i=new f(a,h).next(),j=new u(h);;){d=j.sample();for(var k=!1,l=0;l<h;++l)if(0==d[l]){k=!0;break}if(!k)break}for(var m=b.zeros(a,1),l=0;l<h;++l){var n=i[l],o=d[l];m.setValueAt(n,1,o)}return m.toArray()},a.riskBudgetingWeights=function(a,c,d){void 0===d&&(d={});var e=d.eps||1e-8,f=d.maxIter||1e4,a=new b(a),c=new b(c),g=a.nbRows,h=b.ones(g,1);h=h.normalize(h);for(var i=b.product(a,h),j=Math.sqrt(b.vectorDotProduct(i,h)),k=0,l=!1;!l;){l=!0;for(var m=1;m<=g;++m){var n=a.getValueAt(m,m),o=i.getValueAt(m,1)-h.getValueAt(m,1)*a.getValueAt(m,m),p=-c.getValueAt(m,1)*j,q=o/2,r=q>=0?1:-1,s=q*q-n*p;if(s<0)throw new Error("Discriminant not positive during iteration "+k+", covariance matrix might not be definite positive");var t=-(q+r*Math.sqrt(s)),u=t/n,v=p/t,w=u>0?u:v;h.setValueAt(m,1,w),i=b.product(a,h,i),j=Math.sqrt(b.vectorDotProduct(i,h));var x=h.getValueAt(m,1)*i.getValueAt(m,1)/j;Math.abs(x-c.getValueAt(m,1))>e&&(l=!1)}if(++k,k>f)throw new Error("maximum number of iterations reached: "+f)}return h=h.normalize(h),h.toArray()},a.roundedWeights=function(a,b){return v(a,b)},a}(PortfolioAllocation||{}),"undefined"!=typeof module&&(module.exports=PortfolioAllocation);