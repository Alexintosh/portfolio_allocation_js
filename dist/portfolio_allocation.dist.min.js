/*! portfolio-allocation - v0.0.6 (2018-06-10), Roman Rubsamen <roman.rubsamen@gmail.com> */var PortfolioAllocation=PortfolioAllocation||{};PortfolioAllocation=function(b){function c(a){function b(a){g=d(a.length,a[0].length);for(var b=0;b<g.nbRows;++b){if(!(a[b]instanceof Array))throw new Error("unsupported input type");if(a[b].length!==g.nbColumns)throw new Error("unsupported input type");for(var c=0;c<g.nbColumns;++c)g.data[b*g.nbColumns+c]=a[b][c]}return g}function e(a){g=d(a.length,1);for(var b=0;b<g.nbRows;++b)g.data[b*g.nbColumns]=a[b];return g}function f(a){return g=c.copy(a)}if(!(this instanceof c))return new c(a);var g=this;if(a instanceof Array&&a[0]instanceof Array)return b(a);if(a instanceof Array||"function"==typeof Float64Array&&a instanceof Float64Array)return e(a);if(a instanceof c)return f(a);throw new Error("unsupported input type")}function d(a,b,d){var e;if(void 0===d)e=Object.create(c.prototype),e.nbRows=a,e.nbColumns=b,e.data="function"==typeof Float64Array?new Float64Array(e.nbRows*e.nbColumns):new Array(e.nbRows*e.nbColumns);else{if(!(d instanceof c))throw new Error("provided output must be a matrix");if(d.nbRows!==a||d.nbColumns!==b)throw new Error("provided output matrix size does not match expected matrix size: ("+d.nbRows+","+d.nbColumns+") v.s. ("+a+","+b+")");e=d}return e}function e(a){var b={getCorrelationMatrix:function(a){for(var b=d(this.nbRows,this.nbColumns,a),c=0;c<b.nbRows;++c){for(var e=Math.sqrt(this.data[c*this.nbColumns+c]),f=0;f<c;++f)b.data[c*b.nbColumns+f]=b.data[f*this.nbColumns+c];for(var f=c;f<b.nbColumns;++f){var g=Math.sqrt(this.data[f*this.nbColumns+f]);b.data[c*b.nbColumns+f]=this.data[c*this.nbColumns+f]/(e*g)}}return b},getVariancesVector:function(a){return this.diagonal(a)},standardizedGeneralizedVariance:function(){var a=this.determinant();if(a<0)throw new Error("covariance matrix is not positive semi-definite");var b=Math.pow(a,1/this.nbRows);return b}};for(var c in b)a[c]=b[c]}function f(){if(!(this instanceof f))return new f;this.WORD_LENGTH=32,this.WORD_LOG=5,this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0);var a=this;this.iterator=function(){for(this.w_idx=-1,this.w=0;this.w_idx<a.words.length&&0==this.w;)++this.w_idx,this.w=a.words[this.w_idx];this.next=function(){if(this.w_idx==a.words.length)return 0;var b=this.w&-this.w,c=(this.w_idx<<a.WORD_LOG)+f.populationCount(b-1|0);for(this.w^=b;this.w_idx<a.words.length&&0==this.w;)++this.w_idx,this.w=a.words[this.w_idx];return c}}}function g(a){this.prob="function"==typeof Float64Array?new Float64Array(a.length):new Array(a.length),this.alias="function"==typeof Uint32Array?new Uint32Array(a.length):new Array(a.length);for(var b=1/a.length,c="function"==typeof Uint32Array?new Uint32Array(a.length):new Array(a.length),d=0,e="function"==typeof Uint32Array?new Uint32Array(a.length):new Array(a.length),f=0,g=0;g<a.length;++g)a[g]>b?(e[f]=g,++f):(c[d]=g,++d);for(var a=a.slice(0);d>0&&f>0;){--d;var g=c[d];--f;var h=e[f];this.prob[g]=a.length*a[g],this.alias[g]=h,a[h]=a[h]+(a[g]-b),a[h]>b?(e[f]=h,++f):(c[d]=h,++d)}for(;d>0;)--d,this.prob[c[d]]=1;for(;f>0;)--f,this.prob[e[f]]=1;this.sample=function(){var a=Math.random()*this.prob.length,b=Math.floor(a);return a-b<=this.prob[b]?b:this.alias[b]}}function h(a,b){this.n=a,this.k=b,this.mtc=!1,this.r=new Array(b),this.t=this.n,this.h=0,this.next=function(){if(this.mtc)this.t>1&&(this.h=0),++this.h,this.t=this.r[this.h-1],this.r[this.h-1]=0,this.r[0]=this.t-1,++this.r[this.h];else{this.r[0]=this.n;for(var a=1;a<=this.k-1;++a)this.r[a]=0}return this.mtc=this.r[this.k-1]!=this.n,[this.mtc,this.r.slice()]}}function i(a,b){this.n=a,this.k=b,this.a=new Array(b),this.firstcall=!0,this.mtc=!1,this.m2=0,this.h=this.k,this.endval=this.n-this.k+1,this.next=function(){if(!this.firstcall&&!this.mtc)return-1;this.firstcall?this.firstcall=!1:(this.m2<this.n-this.h&&(this.h=0),++this.h,this.m2=this.a[this.k-this.h]);for(var a=1;a<=this.h;++a)this.a[this.k+a-this.h-1]=this.m2+a;return this.mtc=this.a[0]!=this.endval,this.a.slice()}}function k(a,b){function c(){for(var a=Math.random();0===a;)a=Math.random();return a}this.n=a,this.k=b,this.a=null,this.N,this.nn,this.idx_a,this.selected_record,this.method_a=function(){for(var a=this.N-this.nn;this.nn>=2;){for(var b=c(),d=0,e=a/this.N;e>b;)++d,--a,--this.N,e=e*a/this.N;this.selected_record+=d+1,this.a[this.idx_a++]=this.selected_record,--this.N,--this.nn}var d=Math.floor(this.N*c());d===this.N&&(d=this.N-1),this.selected_record+=d+1,this.a[this.idx_a++]=this.selected_record},this.method_d=function(){for(var a=1/this.nn,b=Math.pow(c(),a),d=-this.nn+1+this.N,e=-13,f=-e*this.nn;this.nn>1&&f<this.N;){for(var g,h,i=1/(-1+this.nn);;){for(;;){if(g=this.N*(-b+1),h=Math.floor(g),h<d)break;b=Math.pow(c(),a)}var j=c(),k=Math.pow(j*this.N/d,i);if(b=k*(-g/this.N+1)*(d/(-h+d)),b<=1)break;var l,m,n=1,o=-1+this.N;-1+this.nn>h?(l=-this.nn+this.N,m=-h+this.N):(l=-1-h+this.N,m=d);for(var p=-1+this.N;p>=m;--p)n=n*o/l,--o,--l;if(this.N/(-g+this.N)>=k*Math.pow(n,i)){b=Math.pow(c(),i);break}b=Math.pow(c(),a)}this.selected_record+=h+1,this.a[this.idx_a++]=this.selected_record,this.N=-h+(-1+this.N),--this.nn,a=i,d=-h+d,f+=e}if(this.nn>1)this.method_a();else{var h=Math.floor(this.N*b);h===this.N&&(h=this.N-1),this.selected_record+=h+1,this.a[this.idx_a++]=this.selected_record}},this.next=function(){if("function"==typeof Uint32Array)this.a=new Uint32Array(this.k);else{this.a=new Array(this.k);for(var a=0;a<this.k;++a)this.a[a]=0}return this.N=this.n,this.nn=this.k,this.idx_a=0,this.selected_record=0,this.method_d(),this.a}}function l(a){this.n=a,this.mtc=!1,this.iin=new Array(a),this.ncard=0,this.next=function(){var a=new Array(0);if(this.mtc){var b=0;if(this.ncard%2!=0)for(++b;0==this.iin[b-1];)++b;this.iin[b]=1-this.iin[b],this.ncard=this.ncard+2*this.iin[b]-1,a=new Array(this.ncard);for(var c=0,d=0;d<=this.n-1;++d)1==this.iin[d]&&(a[c++]=d+1);this.mtc=this.ncard!=this.iin[this.n-1]}else{for(var d=0;d<=this.n-1;++d)this.iin[d]=0;this.mtc=!0}return[this.mtc,a]}}function m(a,b){if(a<0)throw new Error("n must be a positive integer");if(b<0)throw new Error("k must be a positive integer");if(b>a)throw new Error("k must be less than or equal to n");for(var c=1,d=1;d<=b;++d)c*=a+1-d,c/=d;return c}function n(a){for(var b=a.length,d=a[0].nbRows,e=c.zeros(d,1),f=1;f<=d;++f){for(var g=0,h=0;h<b;++h)g+=a[h].getValue(f,1);for(var i=g/b,j=0,h=0;h<b;++h)j+=a[h].getValue(f,1)-i;e.setValue(f,1,(g+j)/b)}return e}function o(a){function b(b){for(var d=0,f=0;f<e;++f){var h=c.xmy(b,a[f],g),i=h.vectorNorm("two");d+=s(i,k)}return d}function d(b){for(var d=c.zeros(f,1),h=0;h<e;++h){var i=c.xmy(b,a[h],g),j=i.vectorNorm("two");d=c.axpby(1,d,1/s(j,k),i,d)}return d}var e=a.length,f=a[0].nbRows,g=c.zeros(f,1),h=n(a),i=function(a){return 0},j=function(a,b){return a},k=.01/e,l=C(b,d,i,j,h,{eps:1e-4,maxIter:-1,maxLine:-1});return l[0]}function p(a,b){for(var c=function(a,b){return a-b},b=b||c,d=a.length,e=a[0],f=0,g=1;g<d;++g)b(a[g],e)>0&&(e=a[g],f=g);return[e,f]}function q(a,b,c){for(var d=function(a,b){return a-b},c=c||d,e=a.length,f=600,g=.5,h=.5,i=10,k="function"==typeof UInt32Array?new UInt32Array(i):new Array(i),l="function"==typeof UInt32Array?new UInt32Array(i):new Array(i),m=0,n=0,o=e-1,b=b-1;;)if(o-n>f&&m<i){var p=o-n+1,q=b-n+1,r=p,s=Math.log(r),t=Math.floor(g*Math.exp(2*s/3)+.5),u=q>=r/2?1:-1,v=h*Math.sqrt(s*t*(1-t/r))*u+.5;v=-1<v&&v<1?0:v>=1?Math.floor(v):Math.ceil(v),q==p/2&&(v=0),k[m]=n,l[m]=o,m++;var w=b-q*(t/r)+v;n<w&&(n=Math.floor(w+.5)),o>w+t&&(o=Math.floor(w+t+.5))}else{if(n>=o){if(0==m)return a[b];--m,n=k[m],o=l[m]}var x=a[b];for(q=n,j=o,a[b]=a[n],a[n]=x,c(x,a[o])<0&&(a[n]=a[o],a[o]=x);q<j;){var y=a[j];for(a[j]=a[q],a[q]=y,++q,--j;c(a[q],x)<0;)++q;for(;c(a[j],x)>0;)--j}if(0==c(a[n],x)){var y=a[n];a[n]=a[j],a[j]=y}else{++j;var y=a[j];a[j]=a[o],a[o]=y}j<=b&&(n=j+1),b<=j&&(o=j-1)}}function r(a){var b=Math.pow(2,-52),c=(2-b)*Math.pow(2,1023),d=Math.pow(2,-1022);if(a!==a)return a;if(a===-1/0)return-c;if(a===1/0)return 1/0;if(a===+c)return 1/0;var e=a*(a<0?1-b/2:1+b);e===a&&(e=d*b>0?a+d*b:a+d),e===1/0&&(e=+c);var f=a+(e-a)/2;a<f&&f<e&&(e=f);var g=(e+a)/2;return a<g&&g<e&&(e=g),0===e?-0:e}function s(a,b){var c=0,d=Math.abs(a),e=Math.abs(b);return d>e?(c=b/a,c=d*Math.sqrt(1+c*c)):0!=b?(c=a/b,c=e*Math.sqrt(1+c*c)):c=0,c}function t(a,b){for(var c=new Array(a.length),d=0;d<a.length;++d)c[d]=[a[d],d];0==b?c.sort(function(a,b){return a[0]>b[0]?-1:1}):1==b&&c.sort(function(a,b){return a[0]<b[0]?-1:1});var e=new Array(a.length);e[c[0][1]]=1;for(var d=1;d<a.length;++d)c[d][0]==c[d-1][0]?e[c[d][1]]=e[c[d-1][1]]:e[c[d][1]]=d+1;return e}function u(a,b){var b=b;void 0===b&&(b=.5);for(var a=new c(a),d=[],e=a.nbRows,f=new Array(e),g=0;g<f.length;++g)f[g]=g+1;for(;0!=f.length;){if(1===f.length){var h=[f[0]];f[0]=null,d.push(h)}else{for(var i=a.submatrix(f,f),j=i.toRowArray(function(a,b,c){return a!=b}),k=new Array(f),g=0;g<f.length;++g)k[g]=v(j[g]);for(var l=0,m=-1,n=-1,o=0,p=-1,q=1,g=0;g<f.length;++g)k[g]>=n&&(l=f[g],m=g,n=k[g]),k[g]<=q&&(o=f[g],p=g,q=k[g]);if(a.getValueAt(l,o)>b){var r=l===o?[l]:[l,o];f[m]=null,f[p]=null;for(var g=0;g<f.length;++g)if(null!==f[g]){var s=(a.getValueAt(f[g],l)+a.getValueAt(f[g],o))/2;s>b&&(r.push(f[g]),f[g]=null)}d.push(r)}else{var t=[l];f[m]=null;for(var g=0;g<f.length;++g)null!==f[g]&&a.getValueAt(f[g],l)>b&&(t.push(f[g]),f[g]=null);if(d.push(t),l!==o){var u=[o];f[p]=null;for(var g=0;g<f.length;++g)null!==f[g]&&a.getValueAt(f[g],o)>b&&(u.push(f[g]),f[g]=null);d.push(u)}}}for(var w=[],g=0;g<f.length;++g)null!==f[g]&&w.push(f[g]);f=w}return d}function v(a){for(var b=a.length,c=0,d=0,e=0;e<b;++e)d+=a[e];c=d/b;for(var f=0,e=0;e<b;++e)f+=a[e]-c;return(d+f)/b}function w(a){for(var b=a.length,c=v(a),d=0,e=0,f=0;f<b;++f){var g=a[f]-c;d+=g*g,e+=g}var h=d-e*e/b;return h/b}function x(a){var b=a.length;return w(a)*b/(b-1)}function y(a){return Math.sqrt(x(a))}function z(a){var b=a,c=0,d=a,e=a*a,f=1;if(a<-8)return 0;if(a>8)return 1;for(;b!=c;)b=(c=b)+(d*=e/(f+=2));return.5+b*Math.exp(-.5*e-.9189385332046728)}function A(a,b){for(var c=a.length,d=v(a),e=v(b),f=0,g=0,h=0,i=0;i<c;++i){var j=a[i]-d,k=b[i]-e;f+=j*k,g+=j,h+=k}var l=f-g*h/c;return l/c}function B(a,b){var c=a.length;return A(a,b)*c/(c-1)}function C(a,b,d,e,f,g){function h(b){return a(b)+d(b)}function i(b,e,f,g){var h=a(f),i=c.xmy(e,f),j=i.vectorNorm("two"),k=d(e),l=h+c.vectorDotProduct(i,g)+1/(2*b)*j*j+k;return l}function j(a,b,d){var f=c.axpby(1,b,-a,d),g=c.copy(e(f,a));return[f,g]}void 0===g&&(g={});for(var k,l,m,n,o,p,q,r,s,t=g.eps||1e-4,u=g.maxIter||1e4,v=g.maxLine||100,w=g.beta||.5,x=g.alphaMin||1e-10,y=g.alphaMax||1e10,z=g.restartPeriod||1e3,A=f.nbRows,B=1e-12,C=.5,D=x,E=c.zeros(A,1),F=c.zeros(A,1),G=c.zeros(A,1),H=c.zeros(A,1),I=c.zeros(A,1),J=!0,K=0;;){if(u!==-1&&K>u)throw new Error("maximum number of iterations reached: "+u);++K,K%z===0&&(f=o,J=!0),J===!0&&(k=0,l=1,m=1,n=null,o=c.copy(f),p=c.copy(o),q=c.copy(p),r=c.zeros(A,1),E=c.copy(b(o),E),F=c.copy(E,F),G=c.copy(F,G),s=c.zeros(A,1),H=c.copy(o,H),I=c.copy(E,I),J=!1);for(var L=D,M=j(L,H,I),N=M[0],O=M[1],P=0;h(O)>i(L,O,H,I)+B;){if(v!==-1&&P>v)throw new Error("maximum number of line searches reached: "+v+" at iteration: "+K);++P,L=w*L,m/=w,l=(1+Math.sqrt(1+4*m*k*k))/2,H=c.axpby(1,p,(k-1)/l,r,H),I=c.axpby(1,F,(k-1)/l,s,I),M=j(L,H,I),N=M[0],O=M[1]}o=O,E=c.copy(b(o),E);var Q=c.xmy(o,p),R=c.xmy(E,F),S=c.vectorDotProduct(Q,Q),T=Math.max(c.vectorDotProduct(R,R),B),U=c.vectorDotProduct(Q,R);if(U<=B)mu_kp_0=y;else{var V=Math.max(x,Math.min(S/U,y)),W=Math.max(x,Math.min(U/T,y));W/V<=C?(mu_kp_0=W,C=.9*C):(mu_kp_0=V,C=1.1*C)}n=L/mu_kp_0;var X=(1+Math.sqrt(1+4*n*l*l))/2,Y=c.axpby(1,o,(l-1)/X,Q),Z=c.axpby(1,E,(l-1)/X,R),$=c.axpby(1/L,N,-1/L,o),_=c.xpy(E,$);if(_.vectorNorm("infinity")<=t)break;var aa=c.vectorDotProduct(c.xmy(H,o),Q);aa>=B&&(f=o,J=!0),D=mu_kp_0,q=p,p=o,r=Q,G=c.copy(F,G),F=c.copy(E,F),s=R,H=c.copy(Y,H),I=c.copy(Z,I),m=n,k=l,l=X}return[o,h(o)]}function D(a,b,d,e,g,h,i){function j(a,b){return a instanceof Array?(a.length=b,a):a instanceof Float64Array||a instanceof Int32Array?a.subarray(0,b):void 0}function k(c){for(var e=v-c*w+x,f=new u.iterator,i=f.next();0!=i;){var j,k=i-1;c<=t[k]?j=h.data[k]:t[k]<=c&&c<=s[k]?j=(b.data[k]-c*d.data[k])/a.data[k]:s[k]<=c&&(j=g.data[k]),e+=d.data[k]*j,i=f.next()}return e}function l(e){for(var f=c.zeros(o,1),i=0;i<o;++i){var j;G<=t[i]?j=h.data[i]:t[i]<=G&&G<=s[i]?j=(b.data[i]-G*d.data[i])/a.data[i]:s[i]<=G&&(j=g.data[i]),f.data[i]=j}return f}void 0===i&&(i={});var m=i.eps||1e-16,n=i.outputLagrangeMultiplier;if(!(a instanceof c&&a.isVector()))throw new Error("first input must be a vector");if(!(b instanceof c&&b.isVector()))throw new Error("second input must be a vector");if(!(d instanceof c&&d.isVector()))throw new Error("third input must be a vector");if(!(g instanceof c&&g.isVector()))throw new Error("fifth input must be a vector");if(!(h instanceof c&&h.isVector()))throw new Error("sixth input must be a vector");if(a.nbRows!==b.nbRows)throw new Error("first and second inputs number of rows do not match: "+a.nbRows+"-"+b.nbRows);if(a.nbRows!==d.nbRows)throw new Error("first and third inputs number of rows do not match: "+a.nbRows+"-"+d.nbRows);if(a.nbRows!==g.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+a.nbRows+"-"+g.nbRows);if(a.nbRows!==h.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+a.nbRows+"-"+h.nbRows);for(var o=d.nbRows,p=Math.abs(e),r="function"==typeof Float64Array?new Float64Array(2*o):new Array(2*o),s="function"==typeof Float64Array?new Float64Array(o):new Array(o),t="function"==typeof Float64Array?new Float64Array(o):new Array(o),u=(new f).setRange(1,o),v=0,w=0,x=0,y=1/0,z=-(1/0),A=0,B=0;A<o;++A){if(g.data[A]>h.data[A])throw new Error("infeasible problem detected");if(d.data[A]<=0)throw new Error("negative element detected in b");if(a.data[A]<=0)throw new Error("negative element detected in d");var C=(b.data[A]-g.data[A]*a.data[A])/d.data[A];s[A]=C,r[B++]=C;var D=(b.data[A]-h.data[A]*a.data[A])/d.data[A];t[A]=D,r[B++]=D,C>z&&(z=C),D<y&&(y=D)}var E=k(y),F=k(z);if(E<e||F>e)throw new Error("infeasible problem detected");var G=null;if(Math.abs(E-e)<=m*p)G=y;else if(Math.abs(E-e)<=m*p)G=z;else{for(var H=y,I=z;0!=r.length;){var J=Math.ceil(r.length/2),K=q(r,J),L=k(K);if(Math.abs(L-e)<=m*p){G=K;break}if(L>e){H=K;for(var B=0,A=J;A<r.length;++A)r[B++]=r[A];r=j(r,B)}else L<e&&(I=K,r=j(r,J-1));for(var M=new u.iterator,N=M.next();0!=N;){var A=N-1,O=!1;if(s[A]<=H&&(x+=d.data[A]*g.data[A],O=!0),I<=t[A]&&(x+=d.data[A]*h.data[A],O=!0),t[A]<=H&&I<=s[A]){var P=d.data[A]/a.data[A];v+=b.data[A]*P,w+=d.data[A]*P,O=!0}O===!0&&u.unset(A+1),N=M.next()}}0==r.length&&(G=(v+x-e)/w)}var Q=l(G),R=.5*c.vectorDotProduct(Q,c.elementwiseProduct(Q,a))-c.vectorDotProduct(b,Q);return n===!0?[Q,R,G]:[Q,R]}function E(b,d,e,f,g,h,i){void 0===i&&(i={});var j=i.eps||1e-4,k=i.maxIter||1e4;if(!(b instanceof c&&b.isSquare()))throw new Error("first input must be a square matrix");if(!(d instanceof c&&d.isVector()))throw new Error("second input must be a vector");if(!(e instanceof c&&e.isVector()))throw new Error("third input must be a vector");if(!(g instanceof c&&g.isVector()))throw new Error("fifth input must be a vector");if(!(h instanceof c&&h.isVector()))throw new Error("sixth input must be a vector");if(b.nbRows!==d.nbRows)throw new Error("first and second inputs number of rows do not match: "+b.nbRows+"-"+a.nbRows);if(b.nbRows!==e.nbRows)throw new Error("first and third inputs number of rows do not match: "+b.nbRows+"-"+e.nbRows);if(b.nbRows!==g.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+b.nbRows+"-"+g.nbRows);if(b.nbRows!==h.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+b.nbRows+"-"+h.nbRows);for(var l=b.nbRows,m=c.fill(l,1,function(a,b){return f/l*1/e.data[a-1]}),n=D(c.ones(l,1),m,e,f,g,h),o=n[0],p=c.xpy(c.xy(b,o),d),q=0;;){if(k!==-1&&q>=k)throw new Error("maximum number of iterations reached: "+k);++q;for(var r=-1,s=-(1/0),t=-1,u=1/0,v=0;v<l;++v)F_i=p.data[v]/e.data[v],g.data[v]<o.data[v]&&o.data[v]<h.data[v]?(F_i>s&&(s=F_i,r=v),F_i<u&&(u=F_i,t=v)):o.data[v]==g.data[v]?F_i<u&&(u=F_i,t=v):o.data[v]==h.data[v]&&F_i>s&&(s=F_i,r=v);if(s-u<=j)break;var w,v=t,x=r,y=(g.data[v]-o.data[v])*e.data[v],z=(o.data[x]-h.data[x])*e.data[x],A=y>=z?y:z,B=(h.data[v]-o.data[v])*e.data[v],C=(o.data[x]-g.data[x])*e.data[x],E=B<=C?B:C,F=u-s,G=b.data[v*b.nbColumns+v]/(e.data[v]*e.data[v])+b.data[x*b.nbColumns+x]/(e.data[x]*e.data[x])-2*b.data[v*b.nbColumns+x]/(e.data[v]*e.data[x]);G>0?(w=-F/G,w>E?w=E:w<A&&(w=A)):w=F>0?A:E;var H=o.data[v],I=o.data[x],J=w/e.data[v],K=-w/e.data[x];o.data[v]+=J,o.data[x]+=K,w==A&&(A==y&&(o.data[v]=g.data[v],J=o.data[v]-H),A==z&&(o.data[x]=h.data[x],K=o.data[x]-I)),w==E&&(E==B&&(o.data[v]=h.data[v],J=o.data[v]-H),E==C&&(o.data[x]=g.data[x],K=o.data[x]-I));for(var L=0;L<l;++L)p.data[L]=p.data[L]+b.data[L*b.nbColumns+v]*J+b.data[L*b.nbColumns+x]*K}var M=.5*c.vectorDotProduct(o,c.xy(b,o))+c.vectorDotProduct(d,o);return[o,M]}function F(a,b,d,e,f,g,h,i){void 0===i&&(i={});var j=i.eps||1e-8,k=i.maxIter||1e5,l=!1,m=!1,n=!1;if(null!==a&&null!==b)l=!0;else{if(null!==a&&null===b)throw new Error("equality constraints vector is missing");if(null===a&&null!==b)throw new Error("equality constraints matrix is missing")}if(null!==d&&null!==e)m=!0;else{if(null!==d&&null===e)throw new Error("inequality constraints vector is missing");if(null===d&&null!==e)throw new Error("inequality constraints matrix is missing")}if(null!==g&&null!==h)n=!0;else{if(null!==g&&null===h)throw new Error("upper bounds constraints vector is missing");if(null===g&&null!==h)throw new Error("lower bounds constraints vector is missing")}if(!(f instanceof c))throw new Error("fifth input must be a matrix");if(1!==f.nbColumns)throw new Error("fifth input is not a vector: "+f.nbColumns+"-"+f.nbRows);if(l){if(!(a instanceof c))throw new Error("first input must be a matrix");if(!(b instanceof c))throw new Error("second input must be a matrix");if(a.nbRows!==b.nbRows)throw new Error("first and second inputs number of rows do not match: "+a.nbRows+"-"+b.nbRows);if(a.nbColumns!==f.nbRows)throw new Error("first input number of columns and fifth input number of rows do not match: "+a.nbColumns+"-"+f.nbRows);if(1!==b.nbColumns)throw new Error("second input is not a vector: "+b.nbColumns+"-"+b.nbRows)}if(m){if(!(d instanceof c))throw new Error("third input must be a matrix");if(!(e instanceof c))throw new Error("third input must be a matrix");if(d.nbRows!==e.nbRows)throw new Error("third and fourth inputs number of rows do not match: "+d.nbRows+"-"+e.nbRows);if(d.nbColumns!==f.nbRows)throw new Error("third input number of columns and fifth input number of rows do not match: "+d.nbColumns+"-"+f.nbRows);if(1!==e.nbColumns)throw new Error("fourth input is not a vector: "+e.nbColumns+"-"+e.nbRows)}if(n){if(null!==g.nbRows){if(!(g instanceof c))throw new Error("sixth input must be a matrix");if(g.nbRows!==f.nbRows)throw new Error("sixth input number of rows and fifth input number of rows do not match: "+g.nbRows+"-"+f.nbRows)}if(null!==h.nbRows){if(!(h instanceof c))throw new Error("seventh input must be a matrix");if(h.nbRows!==f.nbRows)throw new Error("seventh input number of rows and fifth input number of rows do not match: "+h.nbRows+"-"+f.nbRows)}}var o=0,p=null,q=null,r=null;l&&(o=a.nbRows,p=c.zeros(o,1),q=c.zeros(o,1),r=c.zeros(o,1));var s=0,t=null,u=null,v=null;m&&(s=d.nbRows,t=c.zeros(s,1),u=c.zeros(s,1),v=c.zeros(s,1));var w=f.nbRows,x=c.ones(w,1),y=c.ones(w,1),z=c.ones(w,1),A=c.zeros(w,1),B=c.zeros(w,1),C=c.zeros(w,1),D=null;l&&(D=c.zeros(o,1));var E=null;m&&(E=c.zeros(s,1));var F=.9995,G=.9995,H=c.fill(w,1,function(b,c){var e=0;if(l){var f=a.vectorNorm("one","column",b);e+=f}if(m){var g=d.vectorNorm("one","column",b);e+=g}return 0==e&&(e=1),1*F/e}),I=null;l&&(I=c.fill(o,1,function(b,c){var d=a.vectorNorm("one","row",b);return 0==d&&(d=1),1*G/d}));var J=null;m&&(J=c.fill(s,1,function(a,b){var c=d.vectorNorm("one","row",a);return 0==c&&(c=1),1*G/c}));for(var K=0;;){if(k!==-1&&K>=k)throw new Error("maximum number of iterations reached: "+k);if(++K,l&&m?y=c.xpy(c.xpy(c.txy(a,p,B),c.txy(d,t,C),B),f,y):l?y=c.xpy(c.txy(a,p,B),f,y):m&&(y=c.xpy(c.txy(d,t,B),f,y)),y=c.xmy(x,c.elementwiseProduct(y,H,B),y),n)for(var L=1;L<=w;++L)y.data[L-1]<g.data[L-1]?y.data[L-1]=g.data[L-1]:y.data[L-1]>h.data[L-1]&&(y.data[L-1]=h.data[L-1]);else for(var L=1;L<=w;++L)y.data[L-1]<0&&(y.data[L-1]=0);if(z=c.axpby(2,y,-1,x,z),l&&(q=c.xpy(p,c.elementwiseProduct(c.xmy(c.xy(a,z,D),b,D),I,D),q)),m){u=c.xpy(t,c.elementwiseProduct(c.xmy(c.xy(d,z,E),e,E),J,E),u);for(var L=1;L<=s;++L)u.data[L-1]<0&&(u.data[L-1]=0)}A=c.xmy(y,x,A);var M=A.vectorNorm("infinity"),N=y.vectorNorm("infinity"),O=0,P=0;l&&(r=c.xmy(q,p,r),O=r.vectorNorm("infinity"),P=q.vectorNorm("infinity"));var Q=0,R=0;if(m&&(v=c.xmy(u,t,v),Q=v.vectorNorm("infinity"),R=u.vectorNorm("infinity")),M<=j*N&&O<=j*P&&Q<=j*R)break;x=c.copy(y,x),l&&(p=c.copy(q,p)),m&&(t=c.copy(u,t))}var S=c.vectorDotProduct(f,y);return[y,S]}function G(a,b){this.n=a,this.k=b,this.compositionIterator=new h(b,a),this.compositionIteratorStatus=!0,this.sample=function(){if(!this.compositionIteratorStatus)return null;for(var a=this.compositionIterator.next(),b=a[1],c=b.length,d=0;d<c;++d)b[d]=b[d]/this.k;return this.compositionIteratorStatus=a[0],b}}function H(a){this.n=a,this.x="function"==typeof Float64Array?new Float64Array(a):new Array(a),this.sample=function(){for(var a=0,b=0;b<this.n;++b){var c=1-Math.random(),d=Math.log(c);this.x[b]=d,a+=d}for(var b=0;b<this.n;++b)this.x[b]=this.x[b]/a;return this.x.slice()}}function I(a,b){for(var c=b,d=new Array(a.length),e=0;e<a.length;++e){var f=b*a[e],g=Math.floor(f),h=f-g;c-=g,d[e]=[g,h,e]}d.sort(function(a,b){return b[1]<a[1]?-1:b[1]>a[1]?1:b[0]-a[0]});for(var i=new Array(a.length),e=0;e<c;++e){var j=d[e][2];i[j]=(d[e][0]+1)/b}for(var e=c;e<d.length;++e){var j=d[e][2];i[j]=d[e][0]/b}return i}function J(a,b,c){for(var d=Number.POSITIVE_INFINITY,e=[],f=new G(b,c),g=f.sample();null!==g;){var h=a(g);h<d?(d=h,e=[g]):h==d&&e.push(g),g=f.sample()}return e}function K(a,b,d){function e(a,b){return c.vectorDotProduct(a,b)}function f(a,b,c){var d=1e-8,f=c.length-1,g=0,h=c[f][0],i=c[g][0],j=e(b,h),k=e(b,i);if(a-k>d||-d>a-j)return[];if(Math.abs(a-j)<=d)return[[f,h,j]];if(Math.abs(a-k)<=d)return[[g,i,k]];for(;f-g!=1;){var l=Math.floor(g+(f-g)/2),m=c[l][0],n=e(b,m);if(n-a>d)g=l,k=n,i=m;else{if(!(n-a<-d))return[[l,m,n]];f=l,j=n,h=m}}return[[f,h,j],[g,i,k]]}var g=f(b,a,d);if(0==g.length)return[];if(1==g.length){var h=g[0][0],i=g[0][1];return[i,h]}var h=g[0][0],j=g[0][1],k=g[0][2],l=g[1][0],m=g[1][1],n=g[1][2],o=(n-b)/(n-k),i=c.fill(j.nbRows,1,function(a,b){return o*j.getValue(a,1)+(1-o)*m.getValue(a,1)});return[i,h,l]}function L(a,b,d){function e(a,b){return Math.sqrt(c.vectorDotProduct(c.xy(a,b),b))}function f(a,b,c){var d=1e-8,f=c.length-1,g=0,h=c[f][0],i=c[g][0],j=e(b,h),k=e(b,i);if(a-k>d||-d>a-j)return[];if(Math.abs(a-j)<=d)return[[f,h,j]];if(Math.abs(a-k)<=d)return[[g,i,k]];for(;f-g!=1;){var l=Math.floor(g+(f-g)/2),m=c[l][0],n=e(b,m);if(n-a>d)g=l,k=n,i=m;else{if(!(n-a<-d))return[[l,m,n]];f=l,j=n,h=m}}return[[f,h,j],[g,i,k]]}var g=f(b,a,d);if(0==g.length)return[];if(1==g.length){var h=g[0][0],i=g[0][1];return[i,h]}var h=g[0][0],j=g[0][1],k=g[0][2],l=k*k,m=g[1][0],n=g[1][1],o=g[1][2],p=o*o,q=c.vectorDotProduct(c.xy(a,j),n),r=l+p-2*q,s=-2*(p-q),t=p-b*b,u=s/2,v=u>=0?1:-1,w=u*u-r*t;if(w<0)throw new Error("internal error, the covariance matrix might not be semi-definite positive");var x,y=-(u+v*Math.sqrt(w)),z=y/r,A=t/y;if(z>0&&z<1)x=z;else{if(!(A>0&&A<1))throw new Error("internal error, the covariance matrix might not be semi-definite positive");x=A}var i=c.fill(j.nbRows,1,function(a,b){return x*j.getValue(a,1)+(1-x)*n.getValue(a,1)});return[i,h,m]}function M(a){if(0===a.length)throw new Error("internal error: empty list of corner portfolios");return a[a.length-1][0]}function N(a,b,d,e,f){function g(a,b){return Math.sqrt(c.vectorDotProduct(c.xy(a,b),b))}var h,i=1e-8,j=b.nbColumns,k=e[0][0],l=g(b,k);if(d>l+i)h=k;else{var m=e[e.length-1][0],n=g(b,m);if(d<n-i){var o,p=c.fill(j+1,1,function(b,c){return b<=j?a.getValue(b,1):0}),q=c.fill(j+1,j+1,function(a,c){return a<=j&&c<=j?b.getValue(a,c):0}),r=O(p,q,f);if(1===r.length){if(o=r[0][0],1!=r[0][0].getValue(j+1,1))throw new Error("internal error")}else{var s=L(q,d,r);if(0===s.length)throw new Error("internal error");o=s[0]}h=c.fill(j,1,function(a,b){if(a<=j)return o.getValue(a,1)})}else{var s=L(b,d,e);if(0===s.length)throw new Error("internal error");h=s[0]}}return h}function O(a,b,d){function e(a,b){this.STATUS_UNDEF=-1,this.STATUS_IN=0,this.STATUS_LOW=1,this.STATUS_UP=2,this.nbAssets=a,this.nbEqualityConstraints=b,this.varIn=new f,this.varIn.resize(a+b),this.varOut=new f,this.varOut.resize(a+b),this.varLow=new f,this.varLow.resize(a+b),this.varUp=new f,this.varUp.resize(a+b),this.setIn=function(a){this.varIn.set(a),this.varOut.unset(a),this.varLow.unset(a),this.varUp.unset(a)},this.setOnLowerBound=function(a){this.varLow.set(a),this.varOut.set(a),this.varIn.unset(a),this.varUp.unset(a)},this.setOnUpperBound=function(a){this.varUp.set(a),this.varOut.set(a),this.varIn.unset(a),this.varLow.unset(a)},this.setLambdasIn=function(){for(var a=this.nbAssets+1;a<=this.nbAssets+this.nbEqualityConstraints;++a)this.varIn.set(a),this.varOut.unset(a),this.varLow.unset(a),this.varUp.unset(a)},this.setAssetsOnLowerBounds=function(){for(var a=1;a<=this.nbAssets;++a)this.varLow.set(a),this.varOut.set(a),this.varIn.unset(a),this.varUp.unset(a)},this.isAsset=function(a){return a>=1&&a<=this.nbAssets},this.isLambda=function(a){return a>=this.nbAssets+1&&a<=this.nbAssets+this.nbEqualityConstraints},this.isIn=function(a){return this.varIn.get(a)},this.isOnLowerBound=function(a){return this.varLow.get(a)},this.isOnUpperBound=function(a){return this.varUp.get(a)},this.isOut=function(a){return this.varOut.get(a)},this.getInIndexes=function(){return this.varIn.toArray()},this.getOutIndexes=function(){return this.varOut.toArray()}}function g(a,b,d){for(var e=1;e<=l;++e){var f=b.getValue(e,1),g=d.getValue(e,1);if(f>g)throw new Error("infeasible problem detected")}var i=b.sum(),j=d.sum();if(i>1||j<1)throw new Error("infeasible problem detected");for(var k="function"==typeof Uint32Array?new Uint32Array(l):new Array(l),m=0;m<l;++m)k[m]=m+1;k.sort(function(b,c){return a.getValue(c,1)-a.getValue(b,1)});for(var e=1;e<l;++e)if(a.getValue(k[e],1)==a.getValue(k[e-1],1))throw new Error("unsupported problem detected");var n=new c(b);u.setAssetsOnLowerBounds();for(var o=1-n.sum(),p=-1,e=0;e<l&&!(Math.abs(o)<=h);++e){p=k[e];var q=n.getValue(p,1),r=Math.min(d.getValue(p,1)-q,o),s=q+r;s>=d.getValue(p,1)?(n.setValue(p,1,d.getValue(p,1)),u.setOnUpperBound(p)):(n.setValue(p,1,s),u.setIn(p)),o-=r}return p==-1||e==l||u.isIn(p)||(u.setIn(p),d.setValue(p,1,d.getValue(p,1)+2*h)),n}var h=1e-8;void 0===d&&(d={constraints:{}}),void 0===d.constraints&&(d.constraints={});var i=d.maxIter||1e3,j=d.constraints.minWeights,k=d.constraints.maxWeights,l=b.nbColumns,m=c.ones(1,l),n=m.nbRows,o=c.ones(1,1),q=j?new c(j):c.zeros(l,1),r=k?new c(k):c.ones(l,1),s=[],t=null,u=new e(l,n);t=g(a,q,r);var v=c.ones(1,1);if(Math.abs(1-q.sum())<=h||Math.abs(1-r.sum())<=h)return s.push([t,0]),s;for(var w=u.getInIndexes(),x=u.getOutIndexes(),y=c.zeros(l+n,1),z=c.zeros(l+n,1),A=1;A<=x.length;++A){var B=x[A-1];z.setValue(B,1,t.getValue(B,1))}for(var C=c.zeros(l+n,1),D=c.fill(l+n,l+n,function(a,c){return a<=l&&c<=l?b.data[(a-1)*b.nbColumns+(c-1)]:a>=l+1&&c<=l?m.data[(a-l-1)*m.nbColumns+(c-1)]:a<=l&&c>=l+1?m.data[(c-l-1)*m.nbColumns+(a-1)]:0}),E=c.zeros(l+n,l+n),F=c.atxy(-1,v,c.xy(b.submatrix(w,w),v)),G=1;G<=w.length;++G)for(var H=1;H<=w.length;++H){var I=w[G-1],J=v.getValue(G,H);E.setValue(l+H,I,J),E.setValue(I,l+H,J),E.setValue(l+G,l+H,F.getValue(G,H))}u.setLambdasIn();for(var K=c.zeros(l+n,1),A=1;A<=w.length;++A){for(var L=w[A-1],M=0,G=1;G<=x.length;++G){var N=x[G-1];M-=D.getValue(L,N)*t.getValue(N,1)}K.setValue(L,1,M)}for(var A=l+1;A<=l+n;++A){for(var L=A,M=o.getValue(L-l,1),G=1;G<=x.length;++G){var N=x[G-1];M-=D.getValue(L,N)*t.getValue(N,1)}K.setValue(L,1,M)}for(var O=0,P=0,Q=-1,R=0,S=u.STATUS_UNDEF,T=-1,U=0;;){if(i!==-1&&O>=i)throw new Error("maximum number of iterations reached: "+i);if(++O,O>=2)if(R>=U){z.setValue(Q,1,t.getValue(Q,1)),C.setValue(Q,1,0),S==u.STATUS_LOW?u.setOnLowerBound(Q):u.setOnUpperBound(Q);var V=u.getInIndexes(),W=E.getValue(Q,Q);Math.abs(W)<=h&&(W=h);for(var A=1;A<=V.length;++A)for(var L=V[A-1],G=1;G<=V.length;++G){var X=V[G-1];E.setValue(L,X,E.getValue(L,X)-E.getValue(L,Q)*E.getValue(Q,X)/W)}for(var A=1;A<=V.length;++A){var L=V[A-1];K.setValue(L,1,K.getValue(L,1)-D.getValue(L,Q)*t.getValue(Q,1))}}else{for(var V=u.getInIndexes(),A=1;A<=V.length;++A){for(var L=V[A-1],Y=0,G=1;G<=V.length;++G){var X=V[G-1];Y+=E.getValue(L,X)*D.getValue(X,T)}y.setValue(L,1,Y)}for(var Z=D.getValue(T,T),A=1;A<=V.length;++A){var L=V[A-1];Z-=D.getValue(T,L)*y.getValue(L,1)}Math.abs(Z)<=h&&(Z=h);for(var A=1;A<=V.length;++A){for(var L=V[A-1],G=1;G<=V.length;++G){var X=V[G-1];E.setValue(L,X,E.getValue(L,X)+y.getValue(L,1)*y.getValue(X,1)/Z)}E.setValue(L,T,-y.getValue(L,1)/Z),E.setValue(T,L,-y.getValue(L,1)/Z)}E.setValue(T,T,1/Z);for(var A=1;A<=V.length;++A){var L=V[A-1];K.setValue(L,1,K.getValue(L,1)+D.getValue(L,T)*t.getValue(T,1))}u.setIn(T);for(var x=u.getOutIndexes(),M=0,A=1;A<=x.length;++A){var B=x[A-1];M-=D.getValue(T,B)*t.getValue(B,1)}K.setValue(T,1,M)}var V=u.getInIndexes(),x=u.getOutIndexes();Q=-1,R=0,S=u.STATUS_UNDEF;for(var A=1;A<=V.length;++A){for(var L=V[A-1],$=0,_=0,G=1;G<=V.length;++G){var X=V[G-1],aa=E.getValue(L,X);$+=aa*K.getValue(X,1),X<=l&&(_+=aa*a.getValue(X,1))}if(z.setValue(L,1,$),C.setValue(L,1,_),u.isAsset(L))if(_>h){var ba=q.getValue(L,1),ca=(ba-$)/_;ca>=R&&(Q=L,R=ca,S=u.STATUS_LOW)}else if(_<-h){var da=r.getValue(L,1),ca=(da-$)/_;ca>=R&&(Q=L,R=ca,S=u.STATUS_UP)}}T=-1,U=0;for(var A=1;A<=x.length;++A){for(var B=x[A-1],ea=0,fa=-a.getValue(B,1),G=1;G<=l+n;++G){var ga=D.getValue(B,G);ea+=ga*z.getValue(G,1),fa+=ga*C.getValue(G,1)}if(u.isOnLowerBound(B)){if(fa>h){var ha=-ea/fa;ha>=U&&(T=B,U=ha)}}else if(fa<-h){var ha=-ea/fa;ha>=U&&(T=B,U=ha)}}P=p([R,U,0])[0];for(var A=1;A<=V.length;++A){var L=V[A-1];u.isAsset(L)&&t.setValue(L,1,z.getValue(L,1)+P*C.getValue(L,1))}if(s.push([new c(t),P]),P<h)break}var ia=new Array(s.length),ja=0,ka=s[ja][0],la=s[ja][1];ia[ja]=[ka,la];for(var A=1;A<s.length;++A){var ma=s[A][0],na=s[A][1];c.areEqual(ma,ka,h)?ia[ja]=[ma,na]:(ka=ma,la=na,++ja,ia[ja]=[ka,la])}return ia.length=ja+1,ia}return c.prototype={constructor:c,toString:function(){for(var a=0,b=0;b<this.nbRows;++b)for(var c=0;c<this.nbColumns;++c){var d=String(this.data[b*this.nbColumns+c]).length;d>a&&(a=d)}for(var e=[],b=0;b<this.nbRows;++b){e.push("[ ");for(var c=0;c<this.nbColumns;++c){var f=String(this.data[b*this.nbColumns+c]);e.push(new Array(a-f.length+1).join(" ")+f+" ")}e.push("]\n")}return e.join("")},toRowArray:function(a){a=a||function(a,b,c){return!0};for(var b=new Array(this.nbRows),c=0;c<this.nbRows;++c){b[c]=new Array(this.nbColumns);for(var d=0,e=0;e<this.nbColumns;++e){var f=this.data[c*this.nbColumns+e];a(c+1,e+1,f)&&(b[c][d++]=f)}b[c].length=d}return b},toArray:function(a){a=a||function(a,b,c){return!0};for(var b=new Array(this.nbRows*this.nbColumns),c=0,d=0;d<this.nbRows;++d)for(var e=0;e<this.nbColumns;++e){var f=this.data[d*this.nbColumns+e];a(d+1,e+1,f)&&(b[c++]=f)}return b.length=c,b},setValueAt:function(a,b,c){if(a<1||b<1||a>this.nbRows||b>this.nbColumns)throw new Error("index out of bounds when setting matrix value, ("+a+","+b+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(a-1)*this.nbColumns+(b-1)]=c,this},setValue:function(a,b,c){return this.data[(a-1)*this.nbColumns+(b-1)]=c,this},getValueAt:function(a,b){if(a<1||b<1||a>this.nbRows||b>this.nbColumns)throw new Error("index out of bounds when getting matrix value, ("+a+","+b+") in size ("+this.nbRows+","+this.nbColumns+")");
return this.data[(a-1)*this.nbColumns+(b-1)]},getValue:function(a,b){return this.data[(a-1)*this.nbColumns+(b-1)]},isSquare:function(){return this.nbRows===this.nbColumns},isVector:function(){return 1===this.nbColumns},isNonNegative:function(){for(var a=0;a<this.nbRows;++a)for(var b=0;b<this.nbColumns;++b)if(this.data[a*this.nbColumns+b]<0)return!1;return!0},isPositive:function(){for(var a=0;a<this.nbRows;++a)for(var b=0;b<this.nbColumns;++b)if(this.data[a*this.nbColumns+b]<=0)return!1;return!0},isNonPositive:function(){for(var a=0;a<this.nbRows;++a)for(var b=0;b<this.nbColumns;++b)if(this.data[a*this.nbColumns+b]>0)return!1;return!0},isNegative:function(){for(var a=0;a<this.nbRows;++a)for(var b=0;b<this.nbColumns;++b)if(this.data[a*this.nbColumns+b]>=0)return!1;return!0},sum:function(){for(var a=0,b=0;b<this.data.length;++b)a+=this.data[b];return a},min:function(){for(var a=Number.POSITIVE_INFINITY,b=0;b<this.data.length;++b)this.data[b]<a&&(a=this.data[b]);return a},max:function(){for(var a=Number.NEGATIVE_INFINITY,b=0;b<this.data.length;++b)this.data[b]>a&&(a=this.data[b]);return a},normalize:function(a){var b=d(this.nbRows,this.nbColumns,a),c=this.sum();if(0===c)throw new Error("sum of coefficients of matrix is null");for(var e=0;e<this.data.length;++e)b.data[e]=this.data[e]/c;return b},diagonal:function(a){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var b=d(this.nbRows,1,a),c=0;c<this.nbRows;++c)b.data[c]=this.data[c*(this.nbColumns+1)];return b},row:function(a,b){if(a<1||a>this.nbRows)throw new Error("index out of bounds when getting matrix row, ("+a+") in size ("+this.nbRows+","+this.nbColumns+")");for(var c=d(this.nbColumns,1,b),e=0;e<this.nbColumns;++e)c.data[e]=this.data[(a-1)*this.nbColumns+e];return c},elemMap:function(a,b){for(var c=d(this.nbRows,this.nbColumns,b),e=0;e<c.nbRows;++e)for(var f=0;f<c.nbColumns;++f)c.data[e*c.nbColumns+f]=a(e+1,f+1,this.data[e*this.nbColumns+f]);return c},submatrix:function(a,b,c){if(!(a instanceof Array||a instanceof Uint32Array)||0==a.length)throw new Error("first parameter must be a non empty array");if(!(b instanceof Array||b instanceof Uint32Array)||0==b.length)throw new Error("second parameter must be a non empty array");for(var e=1;e<a.length;++e)if(a[e-1]>=a[e])throw new Error("first parameter must be a sorted array");for(var f=1;f<b.length;++f)if(b[f-1]>=a[f])throw new Error("second parameter must be a sorted array");for(var g=d(a.length,b.length,c),e=0;e<g.nbRows;++e)for(var h=a[e]-1,f=0;f<g.nbColumns;++f){var i=b[f]-1;g.data[e*g.nbColumns+f]=this.data[h*this.nbColumns+i]}return g},transpose:function(a){for(var b=d(this.nbColumns,this.nbRows,a),c=0;c<b.nbRows;++c)for(var e=0;e<b.nbColumns;++e)b.data[c*b.nbColumns+e]=this.data[e*this.nbColumns+c];return b},determinant:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var a=c.qrDecomposition(this,{qLess:!0}),b=1,d=0;d<a.data.length;d+=a.nbColumns+1)b*=a.data[d];return b},matrixNorm:function(a){if("one"==a){for(var b=0,c=0;c<this.nbColumns;++c){for(var d=0,e=0;e<this.nbRows;++e)d+=Math.abs(this.data[e*this.nbColumns+c]);b=Math.max(b,d)}return b}if("infinity"==a){for(var f=0,e=0;e<this.nbRows;++e){for(var g=0,c=0;c<this.nbColumns;++c)g+=Math.abs(this.data[e*this.nbColumns+c]);f=Math.max(f,g)}return f}if("frobenius"==a)return this.vectorNorm("two");throw new Error("unsupported matrix norm: "+a)},vectorNorm:function(a,b,c){var d,e,f,g;if(void 0===b||"matrix"==b)d=0,e=this.nbRows,f=0,g=this.nbColumns;else if("row"==b){if(void 0===c)throw new Error("undefined row index");if(c<1||c>this.nbRows)throw new Error("row index out of bounds: "+c);d=c-1,e=c,f=0,g=this.nbColumns}else if("column"==b){if(void 0===c)throw new Error("undefined row index");if(c<1||c>this.nbColumns)throw new Error("column index out of bounds: "+c);d=0,e=this.nbRows,f=c-1,g=c}else if(void 0!==b)throw new Error("unsupported matrix subset: "+b);if("one"==a){for(var h=0,i=d*this.nbColumns,j=d;j<e;++j){for(var k=i+f,l=f;l<g;++l)h+=Math.abs(this.data[k]),k++;i+=this.nbColumns}return h}if("two"==a){for(var m=0,n=1,i=d*this.nbColumns,j=d;j<e;++j){for(var k=i+f,l=f;l<g;++l){var o=this.data[k],p=Math.abs(o);0!=p&&(p>m?(n=1+n*(m/o)*(m/o),m=p):n+=o/m*(o/m)),k++}i+=this.nbColumns}return m*Math.sqrt(n)}if("infinity"==a){for(var q=0,i=d*this.nbColumns,j=d;j<e;++j){for(var k=i+f,l=f;l<g;++l)q=Math.max(q,Math.abs(this.data[k])),k++;i+=this.nbColumns}return q}throw new Error("unsupported vector norm: "+a)}},c.areEqual=function(a,b,d){if(!(a instanceof c))throw new Error("a must be a matrix");if(!(b instanceof c))throw new Error("b must be a matrix");if(a.nbRows!==b.nbRows)return!1;if(a.nbColumns!==b.nbColumns)return!1;for(var e=a.nbRows,f=a.nbColumns,g=e*f,h=d||0,i=0;i<g;++i)if(Math.abs(a.data[i]-b.data[i])>h)return!1;return!0},c.xpy=function(a,b,e){if(!(a instanceof c))throw new Error("first input must be a matrix");if(!(b instanceof c))throw new Error("second input must be a matrix");if(a.nbColumns!==b.nbColumns||a.nbRows!==b.nbRows)throw new Error("input matrices sizes do not match: ("+a.nbRows+","+a.nbColumns+") - ("+b.nbRows+","+b.nbColumns+")");for(var f=d(a.nbRows,a.nbColumns,e),g=a.nbRows*a.nbColumns,h=0;h<g;++h)f.data[h]=a.data[h]+b.data[h];return f},c.xmy=function(a,b,e){if(!(a instanceof c))throw new Error("first input must be a matrix");if(!(b instanceof c))throw new Error("second input must be a matrix");if(a.nbColumns!==b.nbColumns||a.nbRows!==b.nbRows)throw new Error("input matrices sizes do not match: ("+a.nbRows+","+a.nbColumns+") - ("+b.nbRows+","+b.nbColumns+")");for(var f=d(a.nbRows,a.nbColumns,e),g=a.nbRows*a.nbColumns,h=0;h<g;++h)f.data[h]=a.data[h]-b.data[h];return f},c.axpby=function(a,b,e,f,g){if(!(b instanceof c))throw new Error("first input must be a matrix");if(!(f instanceof c))throw new Error("second input must be a matrix");if(b.nbColumns!==f.nbColumns||b.nbRows!==f.nbRows)throw new Error("input matrices sizes do not match: ("+b.nbRows+","+b.nbColumns+") - ("+f.nbRows+","+f.nbColumns+")");for(var h=d(b.nbRows,b.nbColumns,g),i=b.nbRows*b.nbColumns,j=0;j<i;++j)h.data[j]=a*b.data[j]+e*f.data[j];return h},c.copy=function(a,b){if(!(a instanceof c))throw new Error("first input must be a matrix");for(var e=d(a.nbRows,a.nbColumns,b),f=a.nbRows*a.nbColumns,g=0;g<f;++g)e.data[g]=a.data[g];return e},c.elementwiseProduct=function(a,b,e){if(!(a instanceof c))throw new Error("first input must be a matrix");if(!(b instanceof c))throw new Error("second input must be a matrix");if(!(a.nbRows===b.nbRows&&a.nbColumns===b.nbColumns||b.nbRows===a.nbRows&&1===b.nbColumns||1===b.nbRows&&b.nbColumns===a.nbColumns))throw new Error("input matrices sizes do not match: ("+a.nbRows+","+a.nbColumns+") - ("+b.nbRows+","+b.nbColumns+")");var f=d(a.nbRows,a.nbColumns,e),g=a.nbRows,h=a.nbColumns;if(a.nbRows===b.nbRows&&a.nbColumns===b.nbColumns)for(var i=g*h,j=0;j<i;++j)f.data[j]=a.data[j]*b.data[j];else if(b.nbRows===a.nbRows&&1===b.nbColumns)for(var k=0,l=0;l<g;++l)for(var m=b.data[l],n=0;n<h;++n)f.data[k]=a.data[k]*m,k++;else if(1===b.nbRows&&b.nbColumns===a.nbColumns)for(var k=0,l=0;l<g;++l)for(var n=0;n<h;++n)f.data[k]=a.data[k]*b.data[n],k++;return f},c.xy=function(a,b,e){if(!(a instanceof c))throw new Error("first input must be a matrix");if(!(b instanceof c))throw new Error("second input must be a matrix");if(a.nbColumns!==b.nbRows)throw new Error("matrices sizes do not match: ("+a.nbRows+","+b.nbColumns+") - ("+b.nbRows+","+b.nbColumns+")");for(var f=d(a.nbRows,b.nbColumns,e),g=a.nbRows,h=a.nbColumns,i=b.nbColumns,j=0,k=0,l=0;l<g;++l){for(var m=k,n=0;n<i;++n)f.data[m]=0,m++;for(var o=0,p=0;p<h;++p){var q=a.data[j];m=k;for(var n=0;n<i;++n)f.data[m]+=q*b.data[o],o++,m++;j++}k+=i}return f},c.txy=function(a,b,e){if(!(a instanceof c))throw new Error("second input must be a matrix");if(!(b instanceof c))throw new Error("third input must be a matrix");if(a.nbRows!==b.nbRows)throw new Error("matrices sizes do not match: ("+a.nbRows+","+b.nbColumns+") - ("+b.nbRows+","+b.nbColumns+")");for(var f=d(a.nbColumns,b.nbColumns,e),g=a.nbColumns,h=a.nbRows,i=b.nbColumns,j=0,k=0,l=0,m=0;m<g;++m){for(var n=a.data[j],o=q,p=0;p<i;++p)f.data[k]=n*b.data[p],k++;j++}for(var q=i,l=1;l<h;++l){k=0;for(var m=0;m<g;++m){for(var n=a.data[j],o=q,p=0;p<i;++p)f.data[k]+=n*b.data[o],k++,o++;j++}q+=i}return f},c.axy=function(a,b,e,f){if(!(b instanceof c))throw new Error("second input must be a matrix");if(!(e instanceof c))throw new Error("third input must be a matrix");if(b.nbColumns!==e.nbRows)throw new Error("matrices sizes do not match: ("+b.nbRows+","+e.nbColumns+") - ("+e.nbRows+","+e.nbColumns+")");for(var g=d(b.nbRows,e.nbColumns,f),h=b.nbRows,i=b.nbColumns,j=e.nbColumns,k=0,l=0,m=0;m<h;++m){for(var n=l,o=0;o<j;++o)g.data[n]=0,n++;for(var p=0,q=0;q<i;++q){var r=a*b.data[k];n=l;for(var o=0;o<j;++o)g.data[n]+=r*e.data[p],p++,n++;k++}l+=j}return g},c.ax=function(a,b,e){if(!(b instanceof c))throw new Error("second input must be a matrix");for(var f=d(b.nbRows,b.nbColumns,e),g=b.nbRows,h=b.nbColumns,i=1;i<=g;++i)for(var j=1;j<=h;++j)f.setValue(i,j,a*b.getValue(i,j));return f},c.axty=function(a,b,e,f){if(!(b instanceof c))throw new Error("second input must be a matrix");if(!(e instanceof c))throw new Error("third input must be a matrix");if(b.nbColumns!==e.nbColumns)throw new Error("matrices sizes do not match: ("+b.nbRows+","+e.nbColumns+") - ("+e.nbRows+","+e.nbColumns+")");for(var g=d(b.nbRows,e.nbRows,f),h=0;h<b.nbRows;++h)for(var i=0;i<e.nbRows;++i){g.data[h*g.nbColumns+i]=0;for(var j=0;j<b.nbColumns;++j)g.data[h*g.nbColumns+i]+=b.data[h*b.nbColumns+j]*e.data[i*e.nbColumns+j];g.data[h*g.nbColumns+i]=a*g.data[h*g.nbColumns+i]}return g},c.atxy=function(a,b,e,f){if(!(b instanceof c))throw new Error("second input must be a matrix");if(!(e instanceof c))throw new Error("third input must be a matrix");if(b.nbRows!==e.nbRows)throw new Error("matrices sizes do not match: ("+b.nbRows+","+e.nbColumns+") - ("+e.nbRows+","+e.nbColumns+")");for(var g=d(b.nbColumns,e.nbColumns,f),h=0,i=0;i<b.nbColumns;++i){for(var j=a*b.data[h*b.nbColumns+i],k=0;k<e.nbColumns;++k)g.data[i*g.nbColumns+k]=0;for(var k=0;k<e.nbColumns;++k)g.data[i*g.nbColumns+k]+=j*e.data[h*e.nbColumns+k]}for(var h=1;h<b.nbRows;++h)for(var i=0;i<b.nbColumns;++i)for(var j=a*b.data[h*b.nbColumns+i],k=0;k<e.nbColumns;++k)g.data[i*g.nbColumns+k]+=j*e.data[h*e.nbColumns+k];return g},c.diagonal=function(a,b){if(!(a instanceof c&&a.isVector()))throw new Error("first input must be a vector");for(var e=a.nbRows,f=d(e,e,b),g=0;g<e;++g){for(var h=0;h<e;++h)f.data[g*e+h]=0;f.data[g*e+g]=a.data[g]}return f},c.fillSymetric=function(a,b,c){if(a<1)throw new Error("input number of rows and columns out of bounds: "+a);for(var e=d(a,a,c),f=0;f<a;++f){for(var g=0;g<f;++g)e.data[f*a+g]=e.data[g*a+f];for(var g=f;g<e.nbColumns;++g)e.data[f*a+g]=b(f+1,g+1)}return e},c.fill=function(a,b,c,e){if(a<1)throw new Error("input number of rows out of bounds: "+a);if(b<1)throw new Error("input number of columns out of bounds: "+b);for(var f=d(a,b,e),g=0;g<a;++g)for(var h=0;h<b;++h)f.data[g*b+h]=c(g+1,h+1);return f},c.zeros=function(a,b,c){for(var e=d(a,b,c),f=a*b,g=0;g<f;++g)e.data[g]=0;return e},c.ones=function(a,b){for(var c=d(a,b),e=a*b,f=0;f<e;++f)c.data[f]=1;return c},c.identity=function(a){for(var b=d(a,a),c=a*a,e=0;e<c;++e)b.data[e]=0,e%(a+1)==0&&(b.data[e]=1);return b},c.vectorHadamardProduct=function(a,b){return c.elementwiseProduct(a,b)},c.vectorDotProduct=function(a,b){if(!a.isVector())throw new Error("first argument must be a vector");if(!b.isVector())throw new Error("second argument must be a vector");if(a.nbRows!==b.nbRows)throw new Error("Vectors sizes do not match: ("+a.nbRows+") - ("+b.nbRows+")");for(var c=0,d=a.nbRows,e=0;e<d;++e)c+=a.data[e]*b.data[e];return c},c.qrDecomposition=function(a,b){function d(a,b){var c,d,e;if(0==b)c=a>=0?1:-1,d=0,e=Math.abs(a);else if(0==a)c=0,d=b>=0?1:-1,e=Math.abs(b);else if(Math.abs(a)>Math.abs(b)){var f=b/a,g=(a>=0?1:-1)*Math.sqrt(1+f*f);c=1/g,d=f*c,e=a*g}else{var f=a/b,g=(b>=0?1:-1)*Math.sqrt(1+f*f);d=1/g,c=f*d,e=b*g}return[c,-d,e]}void 0===b&&(b={});var e=b.qLess||!1;if(!(a instanceof c))throw new Error("first input must be a matrix");if(a.nbRows<a.nbColumns)throw new Error("matrix has more columns than rows: ("+a.nbRows+") v.s. ("+a.nbColumns+")");var f=a.nbRows,g=a.nbColumns,h=new c(a),i=null;e||(i=c.identity(f));for(var j=1;j<=g;++j)for(var k=f;k>=j+1;--k){var l=(k-2)*h.nbColumns+(j-1),m=(k-1)*h.nbColumns+(j-1),n=h.data[l],o=h.data[m],p=d(n,o),q=p[0],r=p[1],s=p[2];h.data[l]=s,h.data[m]=0;for(var t=j+1;t<=g;++t){var u=(k-2)*h.nbColumns+(t-1),v=(k-1)*h.nbColumns+(t-1),w=h.data[u],x=h.data[v];h.data[u]=q*w-r*x,h.data[v]=r*w+q*x}if(!e)for(var t=1;t<=f;++t){var y=(t-1)*i.nbColumns+(k-2),z=(t-1)*i.nbColumns+(k-1),w=i.data[y],x=i.data[z];i.data[y]=q*w-r*x,i.data[z]=r*w+q*x}}return e?h:[i,h]},c.svdDecomposition=function(a,b){void 0===b&&(b={});var d=b.eps||1e-16,e=b.maxIter||100,f=b.svdForm||"thin";if(!(a instanceof c))throw new Error("first input must be a matrix");if(a.nbRows<a.nbColumns)throw new Error("matrix has more columns than rows: "+a.nbColumns+" v.s. "+a.nbRows);for(var g=a.nbRows,h=a.nbColumns,i=new c(a),j=i.matrixNorm("frobenius"),k=c.identity(h),l=0,m="function"==typeof Float64Array?new Float64Array(h):new Array(h);;){if(++l,e!==-1&&l>e)throw new Error("maximum number of iterations reached: "+e);for(var n=1;n<=h;++n){var o=i.vectorNorm("two","column",n);m[n-1]=o*o}for(var p=!0,n=2;n<=h;++n)for(var q=1;q<=n-1;++q){for(var r=m[q-1],s=m[n-1],t=0,u=1;u<=g;++u)t+=i.data[(u-1)*i.nbColumns+(q-1)]*i.data[(u-1)*i.nbColumns+(n-1)];if(!(Math.abs(t)<=d*Math.sqrt(g*r*s)||Math.sqrt(r)<=d*j||Math.sqrt(s)<=d*j)){p=!1;for(var v=(r-s)/(2*t),w=(v>=0?1:-1)/(Math.abs(v)+Math.sqrt(1+v*v)),x=1/Math.sqrt(1+w*w),y=x*w,u=1;u<=g;++u){var z=i.data[(u-1)*i.nbColumns+(q-1)],A=i.data[(u-1)*i.nbColumns+(n-1)];i.data[(u-1)*i.nbColumns+(q-1)]=x*z+y*A,i.data[(u-1)*i.nbColumns+(n-1)]=-y*z+x*A}m[q-1]+=w*t,m[n-1]-=w*t;for(var u=1;u<=h;++u){var z=k.data[(u-1)*k.nbColumns+(q-1)],A=k.data[(u-1)*k.nbColumns+(n-1)];k.data[(u-1)*k.nbColumns+(q-1)]=x*z+y*A,k.data[(u-1)*k.nbColumns+(n-1)]=-y*z+x*A}}}if(1==p)break}for(var B="function"==typeof Float64Array?new Float64Array(h):new Array(h),C="function"==typeof Uint32Array?new Uint32Array(h):new Array(h),n=1;n<=h;++n){var D=Math.sqrt(m[n-1]);B[n-1]=D,C[n-1]=n}C.sort(function(a,b){return B[b-1]-B[a-1]});for(var E=c.zeros(g,h),F=c.zeros(h,h),G=c.zeros(h,h),n=1;n<=h;++n){var H=C[n-1],I=B[H-1];if(F.data[(n-1)*F.nbColumns+(n-1)]=I,0!=I)for(var q=1;q<=g;++q)E.data[(q-1)*E.nbColumns+(n-1)]=i.data[(q-1)*i.nbColumns+(H-1)]/I;for(var q=1;q<=h;++q)G.data[(q-1)*G.nbColumns+(n-1)]=k.data[(q-1)*k.nbColumns+(H-1)]}if("thin"==f)return[E,F,G];for(var J=c.qrDecomposition(E),K=J[0],L=c.zeros(g,g),M=c.zeros(g,h),n=1;n<=h;++n){var H=C[n-1],I=B[H-1];if(M.data[(n-1)*M.nbColumns+(n-1)]=I,0!=I)for(var q=1;q<=g;++q)L.data[(q-1)*L.nbColumns+(n-1)]=E.data[(q-1)*E.nbColumns+(n-1)];else for(var q=1;q<=g;++q)L.data[(q-1)*L.nbColumns+(n-1)]=K.data[(q-1)*K.nbColumns+(n-1)]}for(var n=h+1;n<=g;++n)for(var q=1;q<=g;++q)L.data[(q-1)*L.nbColumns+(n-1)]=K.data[(q-1)*K.nbColumns+(n-1)];return"full"==f?[L,M,G]:void 0},c.nullSpace=function(a,b){void 0===b&&(b={});var d=b.eps||void 0;if(!(a instanceof c))throw new Error("first input must be a matrix");var e=a.nbRows,f=a.nbColumns,g=null;if(e>=f){var h=c.svdDecomposition(a,{maxIter:-1}),i=h[0],j=h[1],k=h[2];void 0===d&&(d=e*(r(j.data[0])-j.data[0]));var l;for(l=f;l>=1&&!(j.data[(l-1)*j.nbColumns+(l-1)]>d);--l);var m=l;if(m==f)g=c.zeros(f,1);else{g=new c.zeros(f,f-m);for(var n=m+1;n<=f;++n)for(var o=1;o<=f;++o)g.data[(o-1)*g.nbColumns+(n-(m+1)+1-1)]=k.data[(o-1)*k.nbColumns+(n-1)]}}else{var h=c.svdDecomposition(a.transpose(),{maxIter:-1,svdForm:"full"}),i=h[0],j=h[1],k=h[2];void 0===d&&(d=f*(r(j.data[0])-j.data[0]));var l;for(l=e;l>=1&&!(j.data[(l-1)*j.nbColumns+(l-1)]>d);--l);var m=l;if(m==e)g=c.zeros(f,1);else{for(var p=new c.zeros(f,m),n=1;n<=m;++n)for(var o=1;o<=f;++o)p.data[(o-1)*p.nbColumns+(n-1)]=i.data[(o-1)*i.nbColumns+(n-1)];for(var q=c.qrDecomposition(p),s=q[0],g=new c.zeros(f,f-m),n=m+1;n<=f;++n)for(var o=1;o<=f;++o)g.data[(o-1)*g.nbColumns+(n-(m+1)+1-1)]=s.data[(o-1)*s.nbColumns+(n-1)]}}return g},c.linsolveBackSubstitution=function(a,b,e){if(!(a instanceof c))throw new Error("first input must be a matrix");if(!(b instanceof c))throw new Error("second input must be a matrix");if(!a.isSquare())throw new Error("matrix is not square: ("+a.nbRows+","+a.nbColumns+")");if(a.nbRows!==b.nbRows)throw new Error("matrix and second member sizes do not match: ("+a.nbRows+","+a.nbColumns+") - ("+b.nbRows+","+b.nbColumns+")");if(1!==b.nbColumns)throw new Error("b is not a vector: ("+b.nbRows+","+b.nbColumns+")");for(var f=a.nbColumns,g=d(f,1,e),h=f;h>=1;--h){g.data[h-1]=b.data[h-1];for(var i=h+1;i<=f;++i)g.data[h-1]=g.data[h-1]-a.data[(h-1)*a.nbColumns+(i-1)]*g.data[i-1];var j=a.data[(h-1)*a.nbColumns+(h-1)];if(0==j)throw new Error("input matrix is not invertible: zero diagonal coefficient at index "+h);g.data[h-1]=g.data[h-1]/j}return g},c.linsolveExtendedKaczmarz=function(a,b,d){void 0===d&&(d={});var e=d.eps||1e-12,f=d.maxIter||1e5,h=!1;if(void 0!==d.randomized&&(h=d.randomized),!(a instanceof c))throw new Error("first input must be a matrix");if(!(b instanceof c))throw new Error("second input must be a matrix");if(a.nbRows!==b.nbRows)throw new Error("matrix and second member sizes do not match: ("+a.nbRows+","+a.nbColumns+") - ("+b.nbRows+","+b.nbColumns+")");if(1!==b.nbColumns)throw new Error("b is not a vector: ("+b.nbRows+","+b.nbColumns+")");var i=a.nbRows,j=a.nbColumns,k=c.zeros(j,1),l=c.copy(b),m=c.zeros(i,1),n=c.zeros(i,1),o=c.zeros(i,1),p=a.matrixNorm("frobenius"),q=p*p;if(0===p)return k;for(var r="function"==typeof Float64Array?new Float64Array(i):new Array(i),s=1;s<=i;++s){var t=a.vectorNorm("two","row",s);r[s-1]=t*t}for(var u="function"==typeof Float64Array?new Float64Array(j):new Array(j),v=1;v<=j;++v){var w=a.vectorNorm("two","column",v);u[v-1]=w*w}if(0==h)for(var x=0;;){if(++x,f!==-1&&x>=f)throw new Error("maximum number of iterations reached: "+f);for(var s=1;s<=i;++s)if(0!=r[s-1]){for(var y=0,v=1;v<=j;++v)y+=a.data[(s-1)*a.nbColumns+(v-1)]*k.data[(v-1)*k.nbColumns];for(var z=y-(b.data[(s-1)*b.nbColumns+0]-l.data[(s-1)*l.nbColumns+0]),v=1;v<=j;++v)k.data[(v-1)*k.nbColumns]-=z/r[s-1]*a.data[(s-1)*a.nbColumns+(v-1)]}for(var v=1;v<=j;++v)if(0!=u[v-1]){for(var A=0,s=1;s<=i;++s)A+=a.data[(s-1)*a.nbColumns+(v-1)]*l.data[(s-1)*l.nbColumns+0];for(var s=1;s<=i;++s)l.data[(s-1)*l.nbColumns+0]-=A/u[v-1]*a.data[(s-1)*a.nbColumns+(v-1)]}var B=k.vectorNorm("two");o=c.xy(a,k,o),n=c.xmy(b,l,n),m=c.xmy(o,n,m);var C=m.vectorNorm("two");if(C<=e*p*B)break}else{for(var D=c.zeros(j,1),E="function"==typeof Float64Array?new Float64Array(i):new Array(i),s=1;s<=i;++s)E[s-1]=r[s-1]/q;for(var F=new g(E),G="function"==typeof Float64Array?new Float64Array(j):new Array(j),v=1;v<=j;++v)G[v-1]=u[v-1]/q;for(var H=new g(G),x=0;;){if(++x,f!==-1&&x>=f)throw new Error("maximum number of iterations reached: "+f);for(var s=F.sample()+1,y=0,v=1;v<=j;++v)y+=a.data[(s-1)*a.nbColumns+(v-1)]*k.data[(v-1)*k.nbColumns];for(var z=y-(b.data[(s-1)*b.nbColumns+0]-l.data[(s-1)*l.nbColumns+0]),v=1;v<=j;++v)k.data[(v-1)*k.nbColumns]-=z/r[s-1]*a.data[(s-1)*a.nbColumns+(v-1)];for(var v=H.sample()+1,A=0,s=1;s<=i;++s)A+=a.data[(s-1)*a.nbColumns+(v-1)]*l.data[(s-1)*l.nbColumns+0];for(var s=1;s<=i;++s)l.data[(s-1)*l.nbColumns+0]-=A/u[v-1]*a.data[(s-1)*a.nbColumns+(v-1)];if(x%8*Math.min(i,j)===0){var B=k.vectorNorm("two");o=c.xy(a,k,o),n=c.xmy(b,l,n),m=c.xmy(o,n,m);var C=m.vectorNorm("two");D=c.txy(a,l,D);var I=D.vectorNorm("two");if(C<=e*p*B&&I<=e*q*B)break}}}return k},b.covarianceMatrix=function(a){for(var b=arguments,c=d(b.length,b.length),f=0;f<c.nbRows;++f){for(var g=0;g<f;++g)c.data[f*c.nbColumns+g]=c.data[g*c.nbColumns+f];for(var g=f;g<c.nbColumns;++g)c.data[f*c.nbColumns+g]=A(b[f],b[g])}return e(c),c},b.sampleCovarianceMatrix=function(a){for(var b=arguments,c=d(b.length,b.length),f=0;f<c.nbRows;++f){for(var g=0;g<f;++g)c.data[f*c.nbColumns+g]=c.data[g*c.nbColumns+f];for(var g=f;g<c.nbColumns;++g)c.data[f*c.nbColumns+g]=B(b[f],b[g])}return e(c),c},c.prototype.toCovarianceMatrix=function(){new c(this);return e(this),this},f.populationCount=function(a){return a-=a>>>1&1431655765,a=(858993459&a)+(a>>>2&858993459),a=a+(a>>>4)&252645135,a+=a>>>8,a+=a>>>16,63&a},f.prototype={constructor:f,resize:function(a){var b=this.words.length;if(!(b<<this.WORD_LOG>a)){var c=a+this.WORD_LENGTH>>>this.WORD_LOG;if("function"==typeof Uint32Array){var d=new Uint32Array(c);d.set(this.words),this.words=d}else{this.words[c-1]=0;for(var e=b;e<c-1;++e)this.words[e]=0}}},toString:function(){for(var a="",b=this.words.length,c=0;c<b;++c){var d="";d="function"==typeof Uint32Array?this.words[c].toString(2):(this.words[c]>>>0).toString(2),a+=d.length>=this.WORD_LENGTH?d:new Array(this.WORD_LENGTH-d.length+1).join("0")+d}return a},set:function(a){var b=this.words.length;return b<<this.WORD_LOG<=a&&this.resize(a),this.words[a>>>this.WORD_LOG]|=1<<a,this},setRange:function(a,b){var c=this.words.length;c<<this.WORD_LOG<=b&&this.resize(b);for(var d=a;d<=b;++d)this.words[d>>>this.WORD_LOG]|=1<<d;return this},unset:function(a){var b=this.words.length;return b<<this.WORD_LOG<=a&&this.resize(a),this.words[a>>>this.WORD_LOG]&=~(1<<a),this},get:function(a){return 0!==(this.words[a>>>this.WORD_LOG]&1<<a)},clear:function(){return this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0),this},flip:function(a){var b=this.words.length;return b<<this.WORD_LOG<=a&&this.resize(a),this.words[a>>>this.WORD_LOG]^=1<<a,this},isEmpty:function(){for(var a=this.words.length,b=0;b<a;++b)if(0!=this.words[b])return!1;return!0},nbSetBits:function(){for(var a=0,b=this.words.length,c=0;c<b;++c)a+=f.populationCount(0|this.words[c]);return a},toArray:function(){for(var a=new Array(this.nbSetBits()),b=0,c=this.words.length,d=0;d<c;++d)for(var e=this.words[d];0!=e;){var g=e&-e;a[b++]=(d<<this.WORD_LOG)+f.populationCount(g-1|0),e^=g}return a}},b.clusterRiskParityWeights=function(a,d){void 0===d&&(d={});var e=d.clusteringMode||"ftca",a=new c(a).toCovarianceMatrix(a),f=a.nbRows,g=[];if("manual"===e){g=d.clusters||[];for(var h=new Array(f),i=0;i<h.length;++i)h[i]=0;for(var j=0;j<g.length;++j){if(0===g[j].length)throw new Error("empty cluster at index: "+j);for(var k=0;k<g[j].length;++k){var l=g[j][k];if(l<1||l>f)throw new Error("asset index out of bounds: "+l);h[l-1]++}}for(var i=0;i<h.length;++i)if(1!==h[i])throw 0===h[i]?new Error("missing asset index: "+(i+1)):h[i]>1?new Error("duplicate asset index: "+(i+1)):new Error("unknown error")}else{if("ftca"!==e)throw new Error("unsupported clustering method");var m=a.getCorrelationMatrix().toRowArray();g=u(m,d.ftcaThreshold)}for(var n=g.length,o=c.zeros(n,f),i=0;i<n;++i)for(var p=g[i].slice().sort(function(a,b){return a-b}),q=a.submatrix(p,p),r=b.equalRiskContributionWeights(q,d),j=0;j<r.length;++j)o.setValueAt(i+1,p[j],r[j]);var s=o.transpose(),t=c.xy(o,c.xy(a,s)),v=b.equalRiskContributionWeights(t,d),w=c.xy(s,new c(v));return w.toArray()},b.equalRiskBoundingWeights=function(a,d){void 0===d&&(d={}),d.outputPortfolioVolatility=!0;var a=new c(a),e=a.nbRows,f=1/0,g=[],h=[],i=new l(e),j=i.next();do{var j=i.next(),k=j[1],m=a.submatrix(k,k),n=b.equalRiskContributionWeights(m,d),o=n[0],p=n[1],q=p*p/k.length;q<f&&(f=q,g=k,h=o)}while(j[0]);for(var r=c.zeros(e,1),s=0;s<g.length;++s)r.setValueAt(g[s],1,h[s]);return r.toArray()},b.equalRiskBudgetWeights=function(a,b){var d=new c(a).elemMap(function(a,b,c){return 1/Math.sqrt(c)});return d=d.normalize(d),d.toArray()},b.equalRiskContributionWeights=function(a,d){var a=new c(a),e=a.nbRows,f=c.fill(e,1,function(a,b){return 1/e});return b.riskBudgetingWeights(a,f,d)},b.equalWeights=function(a,b){var d=c.fill(a,1,function(b,c){return 1/a});return d.toArray()},b.globalMinimumVarianceWeights=function(a,b){void 0===b&&(b={constraints:{}});var d=b.eps||1e-8,e=b.maxIter||1e4,f=b.constraints.minWeights,g=b.constraints.maxWeights,a=new c(a),h=a.nbRows,i=c.zeros(h,1),j=c.ones(h,1),k=a,l=i,m=j,n=1,o=i;f&&(o=new c(f));var p=j;g&&(p=new c(g));var q=E(k,l,m,n,o,p,{eps:d,maxIter:e}),r=q[0];return r.toArray()},b.gridSearchWeights=function(a,b,c){if(void 0===c&&(c={}),c.optimisationMethod=c.optimisationMethod||"deterministic","deterministic"===c.optimisationMethod){c.rationalGrid=c.rationalGrid||{k:a};var d=c.rationalGrid.k;return J(b,a,d)}throw new Error("unsupported optimisation method")},b.meanVarianceOptimizationWeights=function(a,b,d){void 0===d&&(d={constraints:{}}),void 0===d.constraints&&(d.constraints={});var e=d.optimizationMethod;if(void 0===e)throw new Error("missing optimization method");if("targetReturn"!==e&&"targetVolatility"!==e&&"minimumVariance"!==e&&"maximumTargetVolatility"!==e)throw new Error("unsupported optimization method");var f=d.constraints["return"];if("targetReturn"===e&&void 0===f)throw new Error("missing return constraint");var g=d.constraints.volatility;if("targetVolatility"===e&&void 0===g)throw new Error("missing volatility constraint");var h=d.constraints.maxVolatility;if("maximumTargetVolatility"===e&&void 0===h)throw new Error("missing maximum volatility constraint");var i,a=new c(a),b=new c(b),j=O(a,b,d);if("targetReturn"==e){if(i=K(a,f,j),0==i.length)throw new Error("return not reachable");i=i[0]}else if("targetVolatility"==e){if(i=L(b,g,j),0==i.length)throw new Error("volatility not reachable");i=i[0]}else if("minimumVariance"==e)i=M(j);else{if("maximumTargetVolatility"!=e)throw new Error("internal error");var k={maxIter:d.maxIter,constraints:d.constraints};i=N(a,b,h,j,k)}var l=i;return l.toArray()},b.randomSubspaceMeanVarianceOptimizationWeights=function(a,b,d){var a=new c(a),b=new c(b),e=b.nbColumns;if(e<=2)throw new Error("the number of assets must be equal to or greater than 3");void 0===d&&(d={constraints:{}}),void 0===d.constraints&&(d.constraints={});var f=d.subsetsOptimizationMethod;if(void 0===f&&(f="maximumTargetVolatility"),"maximumTargetVolatility"!==f&&"minimumVariance"!==f)throw new Error("unsupported subsets optimization method");var g=d.constraints.maxVolatility;if("maximumTargetVolatility"===f&&void 0===g)throw new Error("missing maximum portfolio volatility constraint");var h=d.sizeSubsets;if(void 0!=h){if(h<=1||h>=e)throw new Error("the size of the subsets of assets must be between 2 and "+(e-1).toString())}else{var j=1,l=3,p=-Math.sqrt(2*e*(e+3)),q=l/2,r=q*q-j*p,s=-(q+Math.sqrt(r)),t=p/s;h=Math.max(2,Math.floor(t))}var u,v=d.subsetsGenerationMethod||"random",w=d.nbRandomSubsets||128;if("random"===v)u=w;else{if("deterministic"!==v)throw new Error("unsupported subsets of assets generation method");u=m(e,h)}var x=d.subsetsAggregationMethod||"average";if("average"!==x&&"median"!==x)throw new Error("unsupported aggregation method");var y;if("random"===v)y=new k(e,h);else{if("deterministic"!==v)throw new Error("unsupported subsets generation method");y=new i(e,h)}for(var z=0,A=new Array(u),B=c.zeros(h,1),C=c.zeros(h,h),D={maxIter:d.maxIter},E=0;E<u;++E){var F=y.next();B=a.submatrix(F,[1],B),C=b.submatrix(F,F,C);var G=O(B,C,D),H=null;if("maximumTargetVolatility"===f)H=N(B,C,g,G,D);else{if("minimumVariance"!==f)throw new Error("internal error");H=M(G)}for(var I=c.zeros(e,1),J=0;J<h;++J)I.setValueAt(F[J],1,H.getValue(J+1,1));A[z++]=I}if(A.length=z,0===z)throw new Error("internal error: no feasible portfolio generated");if(z!==u)throw new Error("internal error: infeasible portfolios generated");var I=null;if("average"==x)I=n(A);else{if("median"!=x)throw new Error("internal error");I=o(A)}return I.toArray()},b.maximumSharpeRatioWeights=function(a,b,d,e){function f(a,b){return c.vectorDotProduct(a,b)}function g(a,b){return Math.sqrt(c.vectorDotProduct(c.xy(a,b),b))}function h(a,b,c,d){var e=1e-8,h=f(a,d),i=h-c,j=g(b,d);Math.abs(j)<e&&(j=e);var k=i/j;return[k,h,j]}function i(a,b,c,d){var e=d.length-1,f=0,g=d[e][0],i=d[f][0],j=h(a,b,c,g),k=h(a,b,c,i);if(e==f)return[e,g,j];for(;e-f!=1;){var l=Math.floor(f+(e-f)/2),m=d[l][0],n=h(a,b,c,m),o=l+1,p=d[o][0],q=h(a,b,c,p);if(n[0]>q[0])e=l,g=m,j=n;else{if(!(n[0]<q[0])){e=o,g=p,j=q,f=l,i=m,k=n;break}f=l,i=m,k=n}}return[e,g,j]}function j(a,b,d,e,f,g,i){var j=h(a,b,d,f),k=j[0],l=j[1],m=j[2],n=m*m,o=h(a,b,d,i),q=o[0],r=o[1],s=o[2],t=s*s,u=l-r,v=r-d,w=u*u,x=2*u*v,y=v*v,z=c.vectorDotProduct(c.xy(b,f),i),A=n+t-2*z,B=-2*(t-z),C=t,D=w*B-x*A,E=2*(w*C-y*A),F=x*C-y*B,G=E/2,H=G>=0?1:-1,I=G*G-D*F;if(I<0)throw new Error("internal error, the covariance matrix might not be semi-definite positive");var J=-(G+H*Math.sqrt(I)),K=J/D,L=F/J,M=[[f,k],[i,q]];if(K>0&&K<1){var N=c.fill(f.nbRows,1,function(a,b){return K*f.getValue(a,1)+(1-K)*i.getValue(a,1)}),O=h(a,b,d,N),P=O[0];M.push([N,P])}if(L>0&&L<1){var Q=c.fill(f.nbRows,1,function(a,b){return L*f.getValue(a,1)+(1-L)*i.getValue(a,1)}),R=h(a,b,d,Q),S=R[0];M.push([Q,S])}var T=function(a,b){return a[1]-b[1]};return p(M,T)[0]}var a=new c(a),b=new c(b),k=1e-8,l=O(a,b,e),m=l.length-1,n=l[m][0],o=g(b,n);if(o<k){var q=L(b,k,l);if(0==q.length)throw new Error("no corner portfolio with a strictly positive volatility: the covariance matrix might not be semi-definite positive");var r=q[0],s=q[1];l[s]=[r,-1],l.length=s+1}var m=l.length-1,n=l[m][0],t=f(a,n);if(t<d+k){var q=K(a,d+k,l);if(0==q.length)throw new Error("no corner portfolio with a strictly positive excess return");var r=q[0],s=q[1];l[s]=[r,-1],l.length=s+1}var u=i(a,b,d,l),v=u[0],w=u[1],x=u[2][0],y=[[w,x]],z=v+1;if(z<=l.length-1){var A=l[z][0],B=j(a,b,d,z,A,v,w);y.push(B)}var C=v-1;if(C>=0){var D=l[C][0],E=j(a,b,d,v,w,C,D);y.push(E)}var F=function(a,b){return a[1]-b[1]},G=p(y,F)[0],n=G[0];return n.toArray()},b.meanVarianceEfficientFrontierPortfolios=function(a,b,d){void 0===d&&(d={constraints:{}});var e=d.nbPortfolios||100,a=new c(a),b=new c(b),f=O(a,b,d),g=b.nbColumns,h=new Array(e);if(0==f.length)throw new Error("efficient frontier made of no corner portfolios: internal error");if(1==f.length){if(1!=e)throw new Error("efficient frontier made of only one corner portfolio: only one efficient portfolio can be computed");var i=f[0][0],j=c.vectorDotProduct(a,i),k=Math.sqrt(c.vectorDotProduct(c.xy(b,i),i));return[[i.toArray(),j,k]]}if(e<=1)throw new Error("efficient frontier made of several corner portfolios: at least two efficient portfolios must be computed");var l=f[f.length-1][1],m=f[0][1],n=(m-l)/(e-1),o=l,p=f.length-1,q=p-1,r=f[p][1],s=f[q][1],t=f[p][0],u=f[q][0],v=f[p][0],j=c.vectorDotProduct(a,v),k=Math.sqrt(c.vectorDotProduct(c.xy(b,v),v));h[0]=[v.toArray(),j,k];for(var w=1;w<e-1;++w){for(var o=l+w*n;o>s;)--p,--q,r=f[p][1],s=f[q][1],t=f[p][0],u=f[q][0];var x=(o-r)/(s-r),i=c.fill(g,1,function(a,b){return(1-x)*t.getValue(a,1)+x*u.getValue(a,1)}),j=c.vectorDotProduct(a,i),k=Math.sqrt(c.vectorDotProduct(c.xy(b,i),i));h[w]=[i.toArray(),j,k]}o=m,p=1,q=p-1;var y=f[q][0],j=c.vectorDotProduct(a,y),k=Math.sqrt(c.vectorDotProduct(c.xy(b,y),y));return h[e-1]=[y.toArray(),j,k],h},b.meanVarianceCornerPortfolios=function(a,b,d){for(var a=new c(a),b=new c(b),e=O(a,b,d),f=new Array(e.length),g=0;g<e.length;++g){var h=e[g][0],i=c.vectorDotProduct(a,h),j=Math.sqrt(c.vectorDotProduct(c.xy(b,h),h));f[e.length-1-g]=[h.toArray(),i,j]}return f},b.minimaxWeights=function(a,b){void 0===b&&(b={constraints:{}}),void 0===b.constraints&&(b.constraints={});var d=!0;void 0!==b.constraints.fullInvestment&&(d=b.constraints.fullInvestment);var e=b.outputMinimumPortfolioReturn,f=a.length,g=a[0].length,h=c.fill(f+1,1,function(a,b){return a<=f?0:-1}),i=null,j=null;d&&(i=c.fill(1,f+1,function(a,b){return b<=f?1:0}),j=c.ones(1,1));var k=c.fill(g+(d?0:1),f+1,function(b,c){return b<=g?c<=f?-a[c-1][b-1]:1:b==g+1?c<=f?1:0:void 0}),l=c.fill(g+(d?0:1),1,function(a,b){return a<=g?0:a==g+1?1:void 0}),m=c.fill(f+1,1,function(a,b){return a<=f?0:-(1/0)}),n=c.fill(f+1,1,function(a,b){
return a<=f?1:1/0}),o=F(i,j,k,l,h,m,n,{maxIter:-1}),p=o[0],q=p.toArray(function(a,b,c){return a!=f+1}),r=p.data[f];return e===!0?[q,r]:q},b.minCorrWeights=function(a,d){var a=new c(a).toCovarianceMatrix(),e=a.getVariancesVector(),f=e.elemMap(function(a,b,c){return 1/Math.sqrt(c)}),g=a.getCorrelationMatrix(),h=g.nbRows;if(h<=2)return b.equalRiskBudgetWeights(e,d);for(var i=g.toArray(function(a,b,c){return b>a}),j=v(i),k=y(i),l=g.elemMap(function(a,b,c){return a==b?0:1-z((c-j)/k)}),m=l.toRowArray(function(a,b,c){return a!=b}),n=new Array(h),o=0;o<h;++o)n[o]=v(m[o]);var p=t(n,0),q=new c(p,1).normalize();return q=c.xy(l,q).normalize(),q=c.vectorHadamardProduct(q,f).normalize(),q.toArray()},b.mostDiversifiedWeights=function(a,b){void 0===b&&(b={});var d=b.eps||1e-4,e=b.maxIter||1e4,a=new c(a),f=a.nbRows,g=c.zeros(f,1),h=c.fill(f,1,function(a,b){return Number.MAX_VALUE}),i=a,j=g,k=a.diagonal().elemMap(function(a,b,c){return Math.sqrt(c)}),l=1,m=g,n=h,o=E(i,j,k,l,m,n,{eps:d,maxIter:e}),p=o[0].normalize();return p.toArray()},b.minVarWeights=function(a,b){for(var a=new c(a),d=a.nbRows,e=a.toRowArray(),f=new Array(d),g=0;g<d;++g)f[g]=v(e[g]);var h=v(f),i=y(f),j=new c(f,1).elemMap(function(a,b,c){return 1-z((c-h)/i)});j=j.normalize(j);var k=a.diagonal().elemMap(function(a,b,c){return 1/c}).normalize();return j=c.vectorHadamardProduct(j,k).normalize(),j.toArray()},b.randomWeights=function(a,b){void 0===b&&(b={constraints:{}});for(var d,e=b.constraints.minAssets||1,f=b.constraints.maxAssets||a,g=Math.floor(Math.random()*(f-e+1))+e,h=new k(a,g).next(),i=new H(g);;){d=i.sample();for(var j=!1,l=0;l<g;++l)if(0==d[l]){j=!0;break}if(!j)break}for(var m=c.zeros(a,1),l=0;l<g;++l){var n=h[l],o=d[l];m.setValueAt(n,1,o)}return m.toArray()},b.riskBudgetingWeights=function(a,b,d){var e=1e-12;void 0===d&&(d={});for(var f=d.eps||1e-8,g=d.maxIter||1e4,h=d.outputPortfolioVolatility,a=new c(a),b=new c(b),i=a.nbRows,j=c.fill(i,1,function(a,b){return 1/i}),k=c.xy(a,j),l=Math.sqrt(c.vectorDotProduct(k,j)),m=.5*l-c.vectorDotProduct(b,j.elemMap(function(a,b,c){return Math.log(c)})),n=0,o=!1;!o;){o=!0;for(var p=1;p<=i;++p){var q=j.data[p-1],r=a.data[(p-1)*a.nbColumns+(p-1)],s=k.data[p-1]-j.data[p-1]*r,t=-b.data[p-1]*l,u=s/2,v=u>=0?1:-1,w=u*u-r*t;if(w<0)throw new Error("Negative discriminant during iteration "+n+", covariance matrix might not be semi-definite positive");var x=-(u+v*Math.sqrt(w)),y=x/r,z=t/x,A=y>0?y:z;j.data[p-1]=A;for(var B=1;B<=i;++B)k.data[B-1]+=a.data[(B-1)*a.nbColumns+(p-1)]*A,k.data[B-1]-=a.data[(B-1)*a.nbColumns+(p-1)]*q;var C=c.vectorDotProduct(k,j);if(C<0){if(!(-C<e))throw new Error("Negative volatility during iteration "+n+", covariance matrix might not be semi-definite positive");C=0}if(l=Math.sqrt(C),0!=l){var D=j.data[p-1]*k.data[p-1]/l;Math.abs(D-b.data[p-1])>f&&(o=!1)}}var E=.5*l-c.vectorDotProduct(b,j.elemMap(function(a,b,c){return Math.log(c)}));if(Math.abs(E-m)>f&&(o=!1,m=E),++n,n>g)throw new Error("maximum number of iterations reached: "+g)}var F=j.sum();return j=j.normalize(j),h===!0?[j.toArray(),l/F]:j.toArray()},b.roundedWeights=function(a,b){var c=I(a,b);return c},b}(PortfolioAllocation||{}),"undefined"!=typeof module&&(module.exports=PortfolioAllocation);